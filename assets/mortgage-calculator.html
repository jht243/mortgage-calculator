<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mortgage Calculator Widget</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --nav-offset: clamp(6px, 2vw, 14px);
        --app-pad-x: clamp(12px, 4vw, 24px);
      }

      body {
        margin: 0;
        padding: 24px 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        background: transparent;
        color: #e2e8f0;
        overflow-x: hidden;
        overscroll-behavior: auto;
        -webkit-overflow-scrolling: touch;
      }

      .app {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding: 20px var(--app-pad-x) 32px;
        display: grid;
        gap: 18px;
        background: linear-gradient(135deg, rgba(25, 28, 48, 0.9), rgba(20, 23, 42, 0.95));
        border: none;
        border-radius: 0;
        box-shadow: none;
        box-sizing: border-box;
        touch-action: auto;
        overscroll-behavior: auto;
        -webkit-overflow-scrolling: touch;
      }

      header h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      header p {
        margin: 8px 0 0;
        color: rgba(226, 232, 240, 0.75);
        font-size: 14px;
      }

      .section-title {
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.16em;
        color: rgba(148, 163, 184, 0.65);
        text-transform: uppercase;
        margin-bottom: 14px;
      }

      .section-summary {
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.16em;
        color: rgba(148, 163, 184, 0.75);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 18px;
        min-height: 46px;
        line-height: 1.1;
      }

      .section-summary::after {
        content: "";
        width: 9px;
        height: 9px;
        border-right: 2px solid rgba(148, 163, 184, 0.6);
        border-bottom: 2px solid rgba(148, 163, 184, 0.6);
        transform: rotate(45deg);
        margin-left: auto;
        transition: transform 0.24s ease, border-color 0.24s ease;
      }

      details[open] .section-summary::after {
        transform: rotate(-135deg);
      }

      .section-summary:hover::after,
      .section-summary:focus-visible::after {
        border-color: #0ea5e9;
      }

      .collapsible-content {
        padding: 14px 16px;
        margin-top: 0;
        touch-action: auto;
      }

      .collapsible-content .grid + .grid {
        margin-top: 12px;
      }

      .field-group {
        padding: 16px 0 12px;
      }

      .field-group + .field-group {
        border-top: 1px solid rgba(148, 163, 184, 0.08);
        padding-top: 20px;
      }

      .field-group-label {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.7);
        margin: 0 0 14px;
      }

      .field-group-label .icon {
        width: 18px;
        height: 18px;
        border-radius: 6px;
        background: linear-gradient(135deg, rgba(14, 165, 233, 0.45), rgba(99, 102, 241, 0.35));
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: rgba(15, 23, 42, 0.92);
        font-size: 12px;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.25);
      }

      .section-block {
        border-radius: 12px;
        border: 1px solid rgba(71, 85, 105, 0.3);
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.85), rgba(25, 28, 48, 0.9));
        padding: 16px;
        display: grid;
        gap: 12px;
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.4);
        touch-action: auto;
        overscroll-behavior: auto;
        -webkit-overflow-scrolling: touch;
      }

      details.section-block {
        padding: 0;
      }

      details.section-block > summary {
        padding: 0;
      }

      details.section-block > summary.section-summary {
        padding: 0 18px;
        min-height: 46px;
      }

      details.section-block > .collapsible-content {
        padding-bottom: 14px;
      }

      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        touch-action: auto;
      }

      .grid.duo-columns {
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 16px 18px;
      }

      .grid.trio-columns {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px 18px;
      }

      .is-hidden {
        display: none !important;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.68);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      label .field-helper {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.6);
        text-transform: none;
        letter-spacing: 0;
        font-weight: 400;
        margin-top: -2px;
      }

      label.has-error input,
      label.has-error select {
        border-bottom-color: #f87171;
      }

      label .field-message {
        font-size: 10px;
        color: #fca5a5;
        text-transform: none;
        letter-spacing: 0;
        font-weight: 400;
      }

      .percent-field {
        position: relative;
      }

      .percent-field input[type="number"] {
        padding-right: 32px;
      }

      .percent-field::after {
        content: "%";
        position: absolute;
        right: 4px;
        top: 34px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.5);
        pointer-events: none;
      }

      input[type="number"],
      input[type="text"],
      select {
        border: none;
        border-bottom: 1px solid rgba(100, 116, 139, 0.4);
        border-radius: 0;
        background: transparent;
        color: #e2e8f0;
        font-size: 15px;
        padding: 6px 4px;
        transition: border-color 0.2s ease, color 0.2s ease;
      }

      input::placeholder {
        color: rgba(226, 232, 240, 0.38);
      }

      .slider-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 10px;
      }

      .slider-row input[type="range"] {
        flex: 1;
        appearance: none;
        height: 4px;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(14,165,233,0.45), rgba(56,189,248,0.35));
        outline: none;
      }

      .slider-row input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #22d3ee;
        border: 2px solid rgba(15,23,42,0.85);
        box-shadow: 0 4px 10px rgba(14,165,233,0.45);
        cursor: pointer;
      }

      .slider-row input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #22d3ee;
        border: 2px solid rgba(15,23,42,0.85);
        box-shadow: 0 4px 10px rgba(14,165,233,0.45);
        cursor: pointer;
      }

      .slider-value {
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.08em;
        color: rgba(148, 163, 184, 0.9);
        min-width: 54px;
        text-align: right;
        text-transform: uppercase;
      }

      .scenario-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin: 0 auto;
      }

      [data-openai-component="loan-input-form"] .section-title {
        margin-bottom: 12px;
      }

      [data-openai-component="loan-input-form"] .grid {
        margin-top: 12px;
      }

      .scenario-chip {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(167, 139, 250, 0.55); /* light purple border */
        background: rgba(20, 23, 42, 0.85);
        color: #c4b5fd; /* light purple text */
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .scenario-chip:hover,
      .scenario-chip:focus-visible {
        background: rgba(167, 139, 250, 0.14); /* light purple wash */
        border-color: rgba(167, 139, 250, 0.75);
        color: #a78bfa; /* hover text */
        outline: none;
        box-shadow: 0 6px 20px rgba(167, 139, 250, 0.28);
      }

      .scenario-chip.active {
        background: linear-gradient(135deg, rgba(167,139,250,0.32), rgba(167,139,250,0.18));
        border-color: rgba(167, 139, 250, 0.85);
        color: #e9d5ff; /* lighter purple when active */
        box-shadow: 0 10px 28px rgba(167,139,250,0.32);
      }

      .card-controls {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .icon-btn {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        border: 1px solid rgba(34, 211, 238, 0.35);
        background: rgba(15, 23, 42, 0.85);
        color: #22d3ee;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: all 0.18s ease;
      }

      .icon-btn:hover,
      .icon-btn:focus-visible {
        border-color: rgba(14, 165, 233, 0.8);
        color: #0ea5e9;
        box-shadow: 0 8px 20px rgba(14,165,233,0.35);
        outline: none;
      }

      /* Inline tooltips */
      label.has-tip { position: relative; }
      .label-row { display: inline-flex; align-items: center; gap: 8px; }
      .info-wrap { position: relative; display: inline-grid; place-items: center; }
      .info-trigger {
        display: inline-grid;
        place-items: center;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 1px solid rgba(167,139,250,0.6);
        background: radial-gradient(120px 120px at 50% -40%, rgba(167,139,250,0.22), transparent 60%), rgba(32, 35, 60, 0.82);
        color: #c4b5fd;
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        transition: all .18s ease;
      }
      .info-trigger:hover,
      .info-trigger:focus-visible { outline: none; border-color: rgba(167,139,250,0.9); color: #e9d5ff; box-shadow: 0 6px 18px rgba(167,139,250,0.32); }
      .info-bubble {
        position: absolute;
        z-index: 50;
        left: 50%;
        bottom: calc(100% + 8px);
        transform: translateX(-50%);
        min-width: 220px;
        max-width: 320px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(167,139,250,0.45);
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.96), rgba(22, 25, 46, 0.98));
        color: #e2e8f0;
        box-shadow: 0 12px 28px rgba(20, 17, 40, 0.6), 0 0 0 1px rgba(167,139,250,0.12) inset;
        pointer-events: none;
        opacity: 0;
        transition: opacity .18s ease, transform .18s ease;
      }
      .info-bubble { text-transform: none; }
      .info-bubble .tip-title { font-size: 11px; letter-spacing: .04em; text-transform: none; color: #c4b5fd; margin: 0 0 6px; font-weight: 600; }
      .info-bubble .tip-text { font-size: 12px; color: rgba(226,232,240,0.88); margin: 0; line-height: 1.35; text-transform: none; }
      .info-bubble .tip-range { display:block; margin-top:6px; font-size:12px; color:#e9d5ff; text-transform: none; }
      /* Left-aligned tooltip for fields near left edge */
      .info-wrap.tooltip-left .info-bubble { left: 0; transform: translateX(0); }
      .info-wrap:hover .info-bubble,
      .info-trigger:focus + .info-bubble,
      .info-wrap:focus-within .info-bubble { opacity: 1; pointer-events: auto; }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-bottom-color: #0ea5e9;
        color: #f1f5f9;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0;
        margin-top: 10px;
      }

      .checkbox-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin: 0;
      }

      .checkbox-row span {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.75);
        text-transform: none;
        letter-spacing: 0;
      }

      .result-stack {
        display: grid;
        gap: 10px;
      }

      .quick-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px 12px;
      }

      .result-carousel {
        position: relative;
        padding: 0;
      }

      .carousel-nav {
        position: fixed;
        top: 50vh;
        transform: translateY(-50%);
        width: 42px;
        height: 42px;
        border-radius: 999px;
        border: 1.5px solid rgba(14, 165, 233, 0.35);
        background: rgba(14, 165, 233, 0.12);
        color: #0ea5e9;
        display: grid;
        place-items: center;
        cursor: pointer;
        box-shadow: 0 6px 24px rgba(14, 165, 233, 0.25);
        transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        z-index: 100;
        font-size: 24px;
        backdrop-filter: blur(2px);
      }

      .carousel-nav[disabled] {
        opacity: 0.35;
        cursor: default;
      }

      .carousel-nav:not([disabled]):hover,
      .carousel-nav:not([disabled]):focus-visible {
        background: rgba(14, 165, 233, 0.22);
        border-color: #0ea5e9;
        color: #0ea5e9;
        box-shadow: 0 10px 28px rgba(14, 165, 233, 0.35);
        outline: none;
        transform: translateY(-50%) scale(1.06);
      }

      #cardPrev {
        left: var(--nav-offset);
        right: auto;
        bottom: auto;
      }

      #cardNext {
        right: var(--nav-offset);
        left: auto;
        bottom: auto;
      }

      .carousel-window {
        width: 100%;
        overflow-x: hidden;
        overflow-y: visible;
        touch-action: auto;
        overscroll-behavior: auto;
        -webkit-overflow-scrolling: touch;
        height: auto !important;
        min-height: 0;
      }

      .carousel-track {
        display: flex;
        transition: transform 0.35s ease-in-out;
        will-change: transform;
        align-items: flex-start;
      }

      .carousel-slide {
        min-width: 100%;
        flex: 0 0 100%;
        padding: 4px 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        box-sizing: border-box;
      }

      .slide-content {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        display: grid;
        gap: 16px;
        align-content: start;
      }

      .slide-content.tight {
        gap: 16px;
      }

      .slide-content.breakdown {
        gap: 4px;
      }

      .breakdown-card {
        display: grid;
        gap: 12px;
        grid-template-columns: minmax(0, 1fr);
      }

      /* Make breakdown-card qualify as a section-block without adding chrome */
      .section-block.breakdown-card {
        padding: 0;
        border: none;
        background: none;
        box-shadow: none;
      }

      .breakdown-layout {
        display: grid;
        grid-template-columns: 0.9fr 1.1fr;
        gap: 16px;
        align-items: start;
      }

      .breakdown-panel {
        position: relative;
        background: radial-gradient(circle at top, rgba(46, 54, 94, 0.72), rgba(21, 24, 45, 0.88));
        border: 1px solid rgba(88, 116, 182, 0.28);
        border-radius: 14px;
        padding: 12px 20px 20px;
        box-shadow: 0 14px 34px rgba(13, 18, 33, 0.38);
        touch-action: auto;
      }

      .breakdown-chart {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        background: transparent;
        border: none;
        box-shadow: none;
        max-width: 280px;
        margin: 0 auto;
      }

      .breakdown-chart canvas {
        width: 100%;
        height: auto;
        aspect-ratio: 1 / 1;
        display: block;
      }

      .breakdown-chart .chart-value {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #f8fafc;
        font-weight: 700;
        font-size: clamp(22px, 3vw, 34px);
        letter-spacing: -0.015em;
        pointer-events: none;
        z-index: 1;
      }

      .breakdown-chart .chart-value span {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: rgba(165, 243, 252, 0.5);
      }

      .breakdown-list {
        display: grid;
        gap: 10px;
        align-content: stretch;
        overflow: hidden;
        grid-template-rows: repeat(var(--rows, 5), 1fr);
        touch-action: auto;
      }

      .breakdown-row {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        background: linear-gradient(140deg, rgba(28, 34, 64, 0.88), rgba(17, 21, 40, 0.92));
        border: 1px solid rgba(79, 108, 158, 0.28);
        box-shadow: 0 8px 20px rgba(12, 16, 32, 0.32);
        min-height: 0;
      }

      .breakdown-pill {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        font-size: 16px;
        font-weight: 600;
        color: #0f172a;
      }

      .breakdown-pill.primary {
        background: linear-gradient(150deg, rgba(14, 165, 233, 0.95), rgba(14, 165, 233, 0.65));
      }

      .breakdown-pill.accent {
        background: linear-gradient(150deg, rgba(99, 102, 241, 0.9), rgba(59, 130, 246, 0.7));
      }

      .breakdown-pill.subtle {
        background: linear-gradient(150deg, rgba(16, 185, 129, 0.9), rgba(45, 212, 191, 0.7));
      }

      .breakdown-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .breakdown-details .label {
        font-size: 13px;
        color: #f8fafc;
        font-weight: 600;
        letter-spacing: 0.05em;
      }

      .breakdown-details .hint {
        font-size: 11px;
        color: rgba(203, 213, 225, 0.72);
        letter-spacing: 0.02em;
        line-height: 1.35;
      }

      .breakdown-row input[type="number"] {
        width: 100px;
        text-align: right;
        font-size: 15px;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(100, 116, 139, 0.4);
        background: rgba(15, 23, 42, 0.5);
        color: #e2e8f0;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      .breakdown-row input[type="number"]:focus {
        border-color: #0ea5e9;
        background: rgba(14, 165, 233, 0.1);
        outline: none;
        color: #f1f5f9;
      }

      .breakdown-row .value {
        font-size: 18px;
        font-weight: 700;
        color: #ecfeff;
        text-align: right;
        letter-spacing: -0.015em;
      }

      .breakdown-footnote {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.6);
        letter-spacing: 0;
        line-height: 1.4;
        margin-top: 4px;
      }

      .slide-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        letter-spacing: -0.02em;
        color: #f1f5f9;
      }
      .slide-header {
        position: relative;
        margin: 0;
        padding: 0;
      }

      .slide-header p {
        margin: 6px 0 0;
        color: rgba(148, 163, 184, 0.75);
        font-size: 13px;
        line-height: 1.5;
      }
      .rate-indicator {
        position: absolute;
        top: 4px;
        right: 0;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .rate-refresh {
        display: none !important;
      }
      .rate-refresh:hover { background: rgba(14, 165, 233, 0.18); }
      .rate-refresh:focus-visible {
        outline: 2px solid rgba(14, 165, 233, 0.65);
        outline-offset: 2px;
      }
      .rate-refresh svg { width: 16px; height: 16px; }
      .rate-refresh.is-spinning svg {
        animation: rateRefreshSpin 0.9s linear infinite;
      }
      @keyframes rateRefreshSpin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .rate-badge {
        font-size: 11px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #0ea5e9;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(14, 165, 233, 0.35);
        background: linear-gradient(180deg, rgba(14,165,233,0.18), rgba(14,165,233,0.10));
        line-height: 1.6;
        pointer-events: none;
        display: inline-flex;
        align-items: baseline;
        gap: 6px;
        box-shadow: 0 0 0 1px rgba(14,165,233,0.12) inset, 0 8px 24px rgba(14,165,233,0.12);
      }
      .rate-badge .rate-label { color: rgba(14,165,233,0.78); font-weight: 600; letter-spacing: 0.14em; }
      .rate-badge .rate-num { color: #22d3ee; font-weight: 800; font-size: clamp(16px, 2.4vw, 24px); line-height: 1; letter-spacing: 0.01em; }
      .rate-cta {
        position: absolute;
        right: 0;
        top: 44px;
        background: linear-gradient(135deg, rgba(14,165,233,0.18), rgba(14,165,233,0.06));
        border: 1px solid rgba(14,165,233,0.28);
        color: rgba(226, 244, 255, 0.9);
        padding: 8px 20px;
        font: inherit;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        border-radius: 999px;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, border-color 0.18s ease;
        z-index: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        line-height: 1.15;
        white-space: nowrap;
        box-shadow: 0 10px 26px rgba(14,165,233,0.18), 0 0 0 1px rgba(14,165,233,0.08) inset;
        backdrop-filter: blur(6px);
      }
      .rate-cta:hover,
      .rate-cta:focus-visible {
        color: #0df9ff;
        border-color: rgba(13, 249, 255, 0.55);
        background: linear-gradient(135deg, rgba(14,165,233,0.26), rgba(34,211,238,0.12));
        box-shadow: 0 14px 32px rgba(14,165,233,0.26);
        transform: translateY(-1px);
        outline: none;
      }
      .rate-cta svg {
        width: 15px;
        height: 15px;
        display: block;
        color: inherit;
        filter: drop-shadow(0 2px 4px rgba(14,165,233,0.35));
      }

      /* Email modal (overlay) */
      .modal-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding-top: clamp(24px, 8vh, 72px);
        overflow-y: auto;
        background: rgba(2, 6, 23, 0.66);
        z-index: 9999;
      }
      .modal-dialog {
        width: min(420px, 92vw);
        box-sizing: border-box;
        border-radius: 12px;
        border: 1px solid rgba(71, 85, 105, 0.35);
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.9), rgba(25, 28, 48, 0.95));
        box-shadow: 0 10px 40px rgba(2, 6, 23, 0.6);
        padding: 16px;
        display: grid;
        gap: 12px;
      }
      .modal-dialog h3 {
        margin: 0;
        font-size: 16px;
        letter-spacing: -0.01em;
        color: #e2e8f0;
      }
      .modal-dialog p { margin: 0; color: rgba(148,163,184,0.8); font-size: 13px; }
      .modal-dialog input[type="email"] { display:block; width: 100%; max-width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(100,116,139,0.35); background: rgba(15,23,42,0.5); color: #e2e8f0; font-size: 14px; }
      .modal-dialog textarea { display:block; width: 100%; max-width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(100,116,139,0.35); background: rgba(15,23,42,0.5); color: #e2e8f0; font-size: 14px; min-height: 100px; }
      .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 4px; }
      .modal-actions button { background: rgba(37,40,65,0.8); border: 1px solid rgba(100,116,139,0.35); color: rgba(226,232,240,0.92); padding: 8px 12px; font: inherit; font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; border-radius: 8px; cursor: pointer; }
      .modal-actions button.primary { color: #0ea5e9; border-color: rgba(14,165,233,0.5); background: rgba(14,165,233,0.12); }
      .modal-status { min-height: 18px; font-size: 12px; color: rgba(148,163,184,0.9); }

      .toast-container { position: fixed; right: 16px; bottom: 16px; display: grid; gap: 8px; z-index: 10000; }
      .toast { display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(100,116,139,0.35); background: rgba(15,23,42,0.92); color: #e2e8f0; font-size: 12px; letter-spacing: 0.02em; opacity: 0; transform: translateY(6px); transition: opacity .2s ease, transform .2s ease; }
      .toast.show { opacity: 1; transform: translateY(0); }
      .toast.success { border-color: rgba(16,185,129,0.45); color: #a7f3d0; }
      .toast.error { border-color: rgba(239,68,68,0.45); color: #fecaca; }

/* Scoped spacing fixes for breakdown slide */

.carousel-slide[data-card="breakdown"] .slide-header h2 { margin: 0; }

.carousel-slide[data-card="breakdown"] .slide-header p { margin: 0; }

.carousel-slide[data-card="breakdown"] .slide-content > .section-block:first-of-type { margin-top: 0 !important; }

.carousel-slide[data-card="breakdown"] #breakdownChart,

.carousel-slide[data-card="breakdown"] canvas#breakdownChart { margin-top: 0 !important; }

      /* Root-cause fix: prevent this slide from stretching to tallest slide height */
      .carousel-slide[data-card="breakdown"] { align-items: flex-start; }

      /* Ensure the internal grid packs to the top, no vertical distribution */
      .carousel-slide[data-card="breakdown"] .slide-content.breakdown {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        align-content: flex-start;
        row-gap: 8px;
      }

      /* Remove any accidental margins on the first content block */
      .carousel-slide[data-card="breakdown"] .slide-content.breakdown > *:first-child { margin-top: 0 !important; }
      .carousel-slide[data-card="breakdown"] .breakdown-card { margin-top: 0 !important; }
      .carousel-slide[data-card="breakdown"] .slide-content.breakdown > * { margin-block-start: 0 !important; }

      .totals-list {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px 18px;
        font-size: 13px;
        color: rgba(148, 163, 184, 0.9);
      }

      .totals-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .totals-item .label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(148, 163, 184, 0.7);
      }

      .totals-item .value {
        color: #e2e8f0;
        font-weight: 600;
      }

      .result-card {
        border-radius: 12px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.8), rgba(25, 28, 48, 0.85));
        border: 1px solid rgba(71, 85, 105, 0.3);
        display: grid;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.35);
      }

      .result-card .label {
        font-size: 10px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.65);
        font-weight: 600;
      }

      .result-card .value {
        font-size: 26px;
        font-weight: 700;
        color: #f1f5f9;
        letter-spacing: -0.01em;
      }

      .result-card .hint {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.6);
        line-height: 1.4;
      }

      .result-card.primary {
        padding: 24px 20px;
        background: linear-gradient(140deg, rgba(14, 165, 233, 0.18), rgba(20, 23, 42, 0.95));
        border: 1px solid rgba(14, 165, 233, 0.4);
        box-shadow: 0 8px 24px rgba(14, 165, 233, 0.2), 0 0 80px rgba(14, 165, 233, 0.08);
        gap: 10px;
      }

      .result-card.primary .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .result-card.primary .label {
        color: rgba(148, 163, 184, 0.85);
        font-size: 11px;
        letter-spacing: 0.14em;
        font-weight: 600;
      }

      .result-card.primary .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #0ea5e9;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(14, 165, 233, 0.4);
        background: rgba(14, 165, 233, 0.15);
      }

      .result-card.primary .value {
        font-size: 48px;
        font-weight: 700;
        line-height: 1;
        color: #f1f5f9;
        letter-spacing: -0.02em;
      }

      .result-card.secondary {
        background: linear-gradient(135deg, rgba(25, 28, 48, 0.7), rgba(20, 23, 42, 0.75));
        border-color: rgba(71, 85, 105, 0.25);
        padding: 14px;
      }

      .result-card.secondary .value,
      .result-card.secondary .hint {
        font-size: 13px;
        font-weight: 400;
      }

      .result-card.secondary .value {
        color: #f1f5f9;
        font-size: 22px;
      }

      .actions {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        font-size: 10px;
        color: rgba(148, 163, 184, 0.75);
        gap: 8px;
      }

      .actions button {
        background: rgba(37, 40, 65, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.35);
        color: rgba(148, 163, 184, 0.9);
        padding: 8px 14px;
        font: inherit;
        font-size: 11px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .actions button:hover,
      .actions button:focus-visible {
        color: #0ea5e9;
        border-color: #0ea5e9;
        background: rgba(14, 165, 233, 0.15);
        box-shadow: 0 4px 14px rgba(14, 165, 233, 0.25);
        outline: none;
      }

      /* Push the buttons as a group to the right: first button gets auto margin */
      #printBtn { margin-left: auto; }
      @media print { .no-print { display: none !important; } }
      .actions button svg { width: 14px; height: 14px; margin-right: 6px; display: inline-block; vertical-align: middle; }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        font-size: 13px;
      }

      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        text-align: right;
      }

      th {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.6);
      }

      td.label {
        text-align: left;
      }

      .schedule-note {
        margin-top: 10px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.6);
      }

      /* Amortization schedule container: rely on section-block for chrome */
      #schedulePreview {
        overflow: auto;
      }

      @keyframes glow {
        0% {
          box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
        40% {
          box-shadow: 0 0 48px rgba(56, 189, 248, 0.45);
        }
        100% {
          box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
      }

      .glow-animate {
        animation: glow 1s ease-in-out;
      }

      @media (prefers-reduced-motion: reduce) {
        .glow-animate {
          animation: none !important;
        }
        .carousel-track,
        .carousel-nav {
          transition: none !important;
        }
      }

      @media (max-width: 700px) {
        .breakdown-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }

      @media (max-width: 560px) {
        body {
          padding: 18px;
        }

        .app {
          padding: 22px;
        }

        button {
          flex: 1 1 100%;
        }

        #cardPrev {
          left: 6px;
        }

        #cardNext {
          right: 6px;
        }

        .breakdown-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .breakdown-chart {
          padding: 24px;
        }

        .breakdown-chart canvas {
          width: 180px;
          height: 180px;
        }
      }

      /* Subscribe Banner */
      .subscribe-banner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin: 4px 0 8px;
        padding: 12px 18px;
        background: linear-gradient(90deg, rgba(14, 165, 233, 0.12), rgba(14, 165, 233, 0.04));
        border: 1px solid rgba(14, 165, 233, 0.18);
        border-radius: 10px;
      }

      .subscribe-banner.is-hidden {
        display: none;
      }

      .subscribe-banner-text {
        font-size: 14px;
        color: rgba(226, 232, 240, 0.9);
        font-weight: 500;
        letter-spacing: 0.01em;
      }

      .subscribe-banner-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
      }

      .subscribe-banner-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        font: inherit;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #0f172a;
        background: linear-gradient(180deg, #22d3ee, #0ea5e9);
        border: none;
        border-radius: 999px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .subscribe-banner-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
      }

      .subscribe-banner-btn svg {
        width: 16px;
        height: 16px;
      }

      .subscribe-banner-close {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        padding: 0;
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 6px;
        color: rgba(148, 163, 184, 0.8);
        cursor: pointer;
        transition: border-color 0.15s ease, color 0.15s ease;
      }

      .subscribe-banner-close:hover {
        border-color: rgba(148, 163, 184, 0.6);
        color: rgba(226, 232, 240, 0.9);
      }

      .subscribe-banner-close svg {
        width: 16px;
        height: 16px;
      }

      @media (max-width: 640px) {
        .subscribe-banner {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
          text-align: center;
        }

        .subscribe-banner-actions {
          justify-content: center;
        }
      }

      /* Related Calculators Section */
      .related-calculators-section {
        margin-top: 24px;
        padding: 20px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 16px;
        border: 1px solid rgba(71, 85, 105, 0.3);
      }

      .related-calculators-title {
        font-size: 14px;
        font-weight: 600;
        color: rgba(148, 163, 184, 0.9);
        text-align: center;
        margin-bottom: 16px;
      }

      .related-calculators-grid {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .related-calc-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        color: #0ea5e9;
        background: transparent;
        border: 1px solid rgba(14, 165, 233, 0.3);
        border-radius: 999px;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .related-calc-btn:hover {
        background: rgba(14, 165, 233, 0.1);
        border-color: rgba(14, 165, 233, 0.5);
      }

      .related-calc-btn:active {
        transform: scale(0.97);
        background: rgba(14, 165, 233, 0.2);
        border-color: rgba(14, 165, 233, 0.6);
      }

      .related-calc-btn svg {
        width: 18px;
        height: 18px;
      }

      .related-calc-btn-center {
        flex-basis: 100%;
        max-width: 220px;
        justify-content: center;
      }

      @media (max-width: 560px) {
        .related-calculators-grid {
          flex-direction: column;
        }

        .related-calc-btn {
          justify-content: center;
        }

        .related-calc-btn-center {
          max-width: none;
        }
      }

      /* Bottom Action Buttons */
      .bottom-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 24px;
        padding: 20px 0;
        border-top: 1px solid rgba(71, 85, 105, 0.3);
      }

      .bottom-action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 8px;
        font: inherit;
        font-size: 14px;
        font-weight: 500;
        color: rgba(148, 163, 184, 0.85);
        background: transparent;
        border: none;
        cursor: pointer;
        transition: color 0.15s ease, transform 0.1s ease;
        flex: 1;
      }

      .bottom-action-btn:hover {
        color: rgba(226, 232, 240, 1);
      }

      .bottom-action-btn:active {
        transform: scale(0.95);
        color: #0ea5e9;
      }

      .bottom-action-btn svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      @media (max-width: 560px) {
        .bottom-actions {
          flex-wrap: wrap;
          justify-content: center;
          gap: 8px;
        }

        .bottom-action-btn {
          flex: 0 0 auto;
          padding: 10px 12px;
          font-size: 12px;
        }

        .bottom-action-btn svg {
          width: 16px;
          height: 16px;
        }
      }

      /* Saved Calculations Panel (Collapsible) */
      .saved-calcs-panel .section-summary {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .saved-calcs-badge {
        font-size: 14px;
        font-weight: 600;
        padding: 3px 10px;
        background: rgba(14, 165, 233, 0.15);
        color: #38bdf8;
        border-radius: 12px;
      }

      .saved-calcs-badge:empty,
      .saved-calcs-badge[data-count="0"] {
        display: none;
      }

      .saved-calculations-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .saved-calc-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: rgba(37, 40, 65, 0.6);
        border: 1px solid rgba(100, 116, 139, 0.25);
        border-radius: 12px;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      .saved-calc-item:hover {
        border-color: rgba(14, 165, 233, 0.4);
        background: rgba(37, 40, 65, 0.8);
      }

      .saved-calc-info {
        flex: 1;
        min-width: 0;
      }

      .saved-calc-name {
        font-size: 14px;
        font-weight: 600;
        color: #e2e8f0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .saved-calc-meta {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.7);
        margin-top: 4px;
      }

      .saved-calc-actions {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
      }

      .saved-calc-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        padding: 0;
        background: transparent;
        border: 1px solid rgba(100, 116, 139, 0.3);
        border-radius: 8px;
        color: rgba(148, 163, 184, 0.8);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .saved-calc-btn:hover {
        border-color: rgba(14, 165, 233, 0.5);
        color: #0ea5e9;
        background: rgba(14, 165, 233, 0.1);
      }

      .saved-calc-btn.load-btn {
        width: auto;
        padding: 0 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        gap: 4px;
      }

      .saved-calc-btn.delete-btn:hover {
        border-color: rgba(239, 68, 68, 0.5);
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }

      .saved-calc-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Save Modal */
      .save-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .save-modal-overlay.is-open {
        display: flex;
      }

      .save-modal {
        width: 100%;
        max-width: 400px;
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.98), rgba(22, 25, 46, 0.99));
        border: 1px solid rgba(167, 139, 250, 0.3);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }

      .save-modal h3 {
        margin: 0 0 16px;
        font-size: 18px;
        font-weight: 600;
        color: #e2e8f0;
      }

      .save-modal input[type="text"] {
        width: 100%;
        padding: 12px 14px;
        font: inherit;
        font-size: 14px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.4);
        border-radius: 10px;
        color: #e2e8f0;
        margin-bottom: 16px;
        box-sizing: border-box;
      }

      .save-modal input[type="text"]::selection {
        background: rgba(14, 165, 233, 0.4);
        color: #e2e8f0;
      }

      .save-modal input[type="text"]::placeholder {
        color: rgba(148, 163, 184, 0.6);
      }

      .save-modal input[type="text"]:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
      }

      .save-modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .save-modal-btn {
        padding: 10px 20px;
        font: inherit;
        font-size: 13px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .save-modal-btn.cancel {
        background: transparent;
        border: 1px solid rgba(100, 116, 139, 0.4);
        color: rgba(148, 163, 184, 0.9);
      }

      .save-modal-btn.cancel:hover {
        border-color: rgba(148, 163, 184, 0.6);
        color: #e2e8f0;
      }

      .save-modal-btn.primary {
        background: linear-gradient(180deg, #22d3ee, #0ea5e9);
        border: none;
        color: #0f172a;
      }

      .save-modal-btn.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
      }

      /* Highlight action buttons in summary card */
      .result-card.primary {
        position: relative;
      }

      .highlight-actions {
        position: absolute;
        right: 16px;
        bottom: 16px;
        display: flex;
        gap: 10px;
      }

      .highlight-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        padding: 0;
        background: rgba(30, 33, 56, 0.7);
        border: 1px solid rgba(71, 85, 105, 0.4);
        border-radius: 10px;
        color: rgba(148, 163, 184, 0.85);
        cursor: pointer;
        transition: all 0.15s;
      }

      .highlight-action-btn:hover {
        background: rgba(37, 40, 65, 0.9);
        border-color: rgba(100, 116, 139, 0.6);
        color: #e2e8f0;
      }

      .highlight-action-btn svg {
        width: 20px;
        height: 20px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <section class="result-carousel" role="region" aria-roledescription="carousel" aria-label="Mortgage calculator">
        <button class="carousel-nav" id="cardPrev" aria-label="Previous card" aria-controls="resultTrack">&#x2039;</button>
        <div class="carousel-window" tabindex="0">
          <div class="carousel-track" id="resultTrack">
            <div class="carousel-slide" data-card="summary" role="group" aria-roledescription="slide" aria-label="Summary" aria-hidden="false">
              <div class="slide-content">
                <header class="slide-header">
                  <h2>Mortgage Calculator</h2>
                  <div class="rate-indicator" data-openai-component="rate-indicator">
                    <button class="rate-refresh" type="button" aria-label="Refresh today's average rate" data-openai-component="manual-refresh-button">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path fill="currentColor" d="M18.36 6.64A9 9 0 0 0 12 4v2a7 7 0 0 1 6.3 4H16l4 4 4-4h-2.29a9.004 9.004 0 0 0-3.35-3.36Zm-12.72 10.72A9 9 0 0 0 12 20v-2a7 7 0 0 1-6.3-4H8l-4-4-4 4h2.29a9.004 9.004 0 0 0 3.35 3.36Z"/>
                      </svg>
                    </button>
                    <span class="rate-badge" data-openai-component="rate-badge"><span class="rate-label">Today's Average Rate</span> <span class="rate-num"></span></span>
                  </div>
                  <p>Compare loan programs, see monthly costs, and preview payoff timing.<br />Adjust the inputs to explore scenarios.</p>
                </header>

                <!-- Subscribe Banner -->
                <div class="subscribe-banner" id="subscribeBanner">
                  <span class="subscribe-banner-text">Want expert tips to make better mortgage decisions?</span>
                  <div class="subscribe-banner-actions">
                    <button type="button" class="subscribe-banner-btn" id="subscribeBannerBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                      </svg>
                      Subscribe
                    </button>
                    <button type="button" class="subscribe-banner-close" id="subscribeBannerClose" aria-label="Dismiss">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <!-- Saved Calculations Section (collapsed by default, shown when there are saved items) -->
                <details class="section-block collapsible saved-calcs-panel" id="savedCalculationsSection" data-openai-component="saved-calculations" style="display:none">
                  <summary class="section-summary">
                    <span class="summary-title">üìÅ Saved Calculations</span>
                    <span class="saved-calcs-badge" id="savedCalcsBadge">0</span>
                  </summary>
                  <div class="collapsible-content">
                    <div class="saved-calculations-list" id="savedCalculationsList"></div>
                  </div>
                </details>

                <section class="section-block" data-openai-component="loan-input-form">
                  <div class="section-title">Loan basics</div>
                  <div class="scenario-bar" id="scenarioBar">
                    <button type="button" class="scenario-chip" data-scenario="first-time">First-time buyer 3% down</button>
                    <button type="button" class="scenario-chip" data-scenario="conventional">20% down conventional</button>
                    <button type="button" class="scenario-chip" data-scenario="va">VA zero-down</button>
                  </div>
                  <div class="grid">
                    <label>
                      Loan program
                      <select id="loan_type">
                        <option value="conventional">Conventional</option>
                        <option value="FHA">FHA</option>
                        <option value="VA">VA</option>
                        <option value="USDA">USDA</option>
                      </select>
                    </label>
                    <label>
                      Home value ($)
                      <input type="number" id="home_value" min="0" step="1000" />
                      <span class="field-message" data-field-error="home_value"></span>
                    </label>
                    <label>
                      Down payment ($)
                      <input type="number" id="down_payment_value" min="0" step="1000" />
                      <span class="field-message" data-field-error="down_payment_value"></span>
                      <div class="slider-row">
                        <input type="range" id="down_payment_slider" min="0" max="80" step="1" aria-label="Down payment percent" />
                        <span class="slider-value" id="down_payment_slider_display">0%</span>
                      </div>
                    </label>
                    <label class="percent-field">
                      Rate (APR %)
                      <input type="number" id="rate_apr" min="0" step="0.01" />
                      <span class="field-message" data-field-error="rate_apr"></span>
                      <div class="slider-row">
                        <input type="range" id="rate_slider" min="0" max="12" step="0.05" aria-label="Rate percent" />
                        <span class="slider-value" id="rate_slider_display">0%</span>
                      </div>
                    </label>
                    <label>
                      Term (years)
                      <input type="number" id="term_years" min="1" step="1" />
                      <span class="field-message" data-field-error="term_years"></span>
                      <div class="slider-row">
                        <input type="range" id="term_slider" min="5" max="40" step="1" aria-label="Term years" />
                        <span class="slider-value" id="term_slider_display">30y</span>
                      </div>
                    </label>
                  </div>
                </section>

                <details class="section-block collapsible" id="propertyMortgageFees">
                  <summary class="section-summary">Property, mortgage, and fees</summary>
                  <div class="collapsible-content">
                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">üè†</span> My information</p>
                      <div class="grid duo-columns">
                        <label>
                          ZIP code
                          <span class="field-helper">Location for tax estimates</span>
                          <input type="text" id="zip_code" inputmode="numeric" pattern="\d*" maxlength="9" placeholder="e.g. 94043" />
                        </label>
                        <label>
                          Credit score
                          <span class="field-helper">Affects interest rate</span>
                          <select id="credit_score">
                            <option value="">Select</option>
                            <option value="760+">760+</option>
                            <option value="720-759">720-759</option>
                            <option value="680-719">680-719</option>
                            <option value="640-679">640-679</option>
                            <option value="600-639">600-639</option>
                            <option value="<600">Below 600</option>
                          </select>
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">üìç</span> Property information</p>
                      <div class="grid trio-columns">
                        <label class="percent-field has-tip">
                          <span class="label-row">Property tax <span class="info-wrap"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                            <p class="tip-title">What is this?</p>
                            <p class="tip-text">Annual property tax as a percent of the assessed home value. Jurisdictions vary widely.</p>
                            <span class="tip-range">Typical range: 0.5%‚Äì2.5% yearly</span>
                          </div></span></span>
                          <span class="field-helper">Annual % of assessed value</span>
                          <input type="number" id="property_tax_input" min="0" step="0.01" />
                        </label>
                        <label class="has-tip">
                          <span class="label-row">Homeowners insurance <span class="info-wrap"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                            <p class="tip-title">What is this?</p>
                            <p class="tip-text">Annual premium for hazard insurance that protects your home and belongings.</p>
                            <span class="tip-range">Typical range: $800‚Äì$2,500 per year (‚âà0.2%‚Äì0.5% of value)</span>
                          </div></span></span>
                          <span class="field-helper">Annual cost in dollars</span>
                          <input type="number" id="homeowners_insurance_yearly" min="0" step="50" />
                        </label>
                        <label class="has-tip">
                          <span class="label-row">HOA dues <span class="info-wrap"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                            <p class="tip-title">What is this?</p>
                            <p class="tip-text">Monthly fee charged by a homeowners association for shared services and amenities.</p>
                            <span class="tip-range">Typical range: $0‚Äì$600 per month (many condos $200‚Äì$400)</span>
                          </div></span></span>
                          <span class="field-helper">Monthly cost in dollars</span>
                          <input type="number" id="hoa_monthly" min="0" step="10" />
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">üí≥</span> Mortgage insurance & fees</p>
                      <div class="grid trio-columns">
                        <label class="percent-field has-tip">
                          <span class="label-row">PMI <span class="info-wrap tooltip-left"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                            <p class="tip-title">What is this?</p>
                            <p class="tip-text">Private mortgage insurance for conventional loans when down payment &lt; 20% (LTV &gt; 80%).</p>
                            <span class="tip-range">Typical range: 0.2%‚Äì1.5% of loan balance yearly</span>
                          </div></span></span>
                          <span class="field-helper">Annual % (conventional only)</span>
                          <input type="number" id="pmi_pct" min="0" step="0.01" />
                        </label>
                        <label class="percent-field" data-mi-only>
                          Annual MI fee
                          <span class="field-helper">% of remaining balance</span>
                          <input type="number" id="annual_mi_pct" min="0" step="0.01" />
                        </label>
                        <label class="percent-field">
                          Upfront fee
                          <span class="field-helper">% of base loan amount</span>
                          <input type="number" id="upfront_fee_pct" min="0" step="0.01" />
                          <div class="checkbox-row" style="flex-wrap: wrap; gap: 8px 24px; justify-content: center;">
                            <label style="display: flex; align-items: center; gap: 8px; text-transform: none;">
                              <input type="checkbox" id="finance_upfront_fee" />
                              <span>Add to principal</span>
                            </label>
                            <label class="is-hidden" id="va_disabled_veteran_row" style="display: flex; align-items: center; gap: 8px; text-transform: none;">
                              <input type="checkbox" id="va_disabled_veteran" />
                              <span class="label-row">Disabled Veteran <span class="info-wrap tooltip-left"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                                <p class="tip-title">What is this?</p>
                                <p class="tip-text">If you are a disabled veteran at least 10%, VA will waive your funding fee.</p>
                              </div></span></span>
                            </label>
                          </div>
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">‚öôÔ∏è</span> Advanced options</p>
                      <div class="grid duo-columns">
                        <label>
                          First payment month
                          <span class="field-helper">1-12 for Jan-Dec</span>
                          <input type="number" id="start_month" min="1" max="12" step="1" />
                          <span class="field-message" data-field-error="start_month"></span>
                        </label>
                        <label>
                          First payment year
                          <span class="field-helper">Year of first payment</span>
                          <input type="number" id="start_year" min="2024" step="1" />
                          <span class="field-message" data-field-error="start_year"></span>
                        </label>
                        <label>
                          Extra payment
                          <span class="field-helper">Additional monthly principal</span>
                          <input type="number" id="extra_principal_monthly" min="0" step="50" />
                        </label>
                        <label>
                          Extra starts at month
                          <span class="field-helper">Month index when extra begins</span>
                          <input type="number" id="extra_start_month_index" min="0" step="1" />
                        </label>
                      </div>
                    </div>
                  </div>
                </details>

                <div class="result-stack">
                  <div class="result-card primary" id="monthlyPaymentCard" data-openai-component="monthly-summary-card">
                    <div class="card-header">
                      <span class="label">Monthly payment (month 0)</span>
                      <div class="card-controls">
                        <span class="badge">All-in payment</span>
                      </div>
                    </div>
                    <span class="value" id="total_monthly_0" aria-live="polite">$0</span>
                    <span class="hint">Includes P&I, MI, taxes, insurance, HOA (excludes extra principal).</span>
                    <!-- Highlight action buttons -->
                    <div class="highlight-actions">
                      <button type="button" class="highlight-action-btn" id="highlightPrintBtn" title="Print">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="6 9 6 2 18 2 18 9"/>
                          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                          <rect width="12" height="8" x="6" y="14"/>
                        </svg>
                      </button>
                      <button type="button" class="highlight-action-btn" id="highlightSaveBtn" title="Save">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                          <polyline points="17 21 17 13 7 13 7 21"/>
                          <polyline points="7 3 7 8 15 8"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="quick-metrics" data-openai-component="quick-metrics">
                    <div class="result-card secondary">
                      <span class="label">Principal & interest</span>
                      <span class="value" id="p_and_i">$0</span>
                      <span class="hint">Level payment before extra principal or add-ons.</span>
                    </div>
                    <div class="result-card secondary">
                      <span class="label">Total interest over loan</span>
                      <span class="value" id="total_interest">$0</span>
                      <span class="hint" id="interest_hint"></span>
                    </div>
                    <div class="result-card secondary">
                      <span class="label">Estimated payoff date</span>
                      <span class="value" id="payoff_date">‚Äî</span>
                      <span class="hint" id="term_hint"></span>
                    </div>
                  </div>

                  <!-- Related Calculators Section -->
                  <div class="related-calculators-section">
                    <div class="related-calculators-title">Related Calculators</div>
                    <div class="related-calculators-grid">
                      <button type="button" class="related-calc-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                          <polyline points="17 6 23 6 23 12"/>
                        </svg>
                        Retirement Calculator
                      </button>
                      <button type="button" class="related-calc-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                          <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                        Rental Property Calculator
                      </button>
                      <button type="button" class="related-calc-btn related-calc-btn-center">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Investment Calculator
                      </button>
                    </div>
                  </div>

                  <!-- Bottom Action Buttons -->
                  <div class="bottom-actions">
                    <button type="button" class="bottom-action-btn" id="subscribeBtnBottom">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                      </svg>
                      Subscribe
                    </button>
                    <button type="button" class="bottom-action-btn" id="resetBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M8 16H3v5"/>
                      </svg>
                      Reset
                    </button>
                    <button type="button" class="bottom-action-btn" id="donateBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                      </svg>
                      Donate
                    </button>
                    <button type="button" class="bottom-action-btn" id="feedbackBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="14" x="3" y="4" rx="2"/>
                        <path d="M3 8h18"/>
                        <path d="M8 4v4"/>
                        <path d="M16 4v4"/>
                      </svg>
                      Feedback
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="carousel-slide" data-card="breakdown" role="group" aria-roledescription="slide" aria-label="Monthly breakdown" aria-hidden="true">
              <div class="slide-content breakdown">
                <header class="slide-header">
                  <h2>Monthly payment breakdown</h2>
                  <p>Visualize the components of your monthly payment.</p>
                </header>
                <div class="breakdown-card section-block">
                  <div class="breakdown-panel breakdown-layout">
                    <div class="breakdown-chart" data-openai-component="breakdown-chart">
                      <canvas id="breakdownChart"></canvas>
                      <div class="chart-value" id="chartTotal">
                        $0<span>/mo</span>
                      </div>
                    </div>
                    <div class="breakdown-list" id="breakdown_list">
                      <div class="breakdown-row">
                        <div class="breakdown-pill primary">üí∞</div>
                        <div class="breakdown-details">
                          <span class="label">Principal & interest</span>
                          <span class="hint">Scheduled P&I payment</span>
                        </div>
                        <span class="value" id="breakdown_p_and_i">$0</span>
                      </div>
                      <div class="breakdown-row">
                        <div class="breakdown-pill accent">üè°</div>
                        <div class="breakdown-details">
                          <span class="label">Property tax</span>
                          <span class="hint">Monthly property tax</span>
                        </div>
                        <span class="value" id="breakdown_tax">$0</span>
                      </div>
                      <div class="breakdown-row">
                        <div class="breakdown-pill accent">üõ°Ô∏è</div>
                        <div class="breakdown-details">
                          <span class="label">Homeowner's insurance</span>
                          <span class="hint">Monthly insurance cost</span>
                        </div>
                        <span class="value" id="breakdown_ins">$0</span>
                      </div>
                      <div class="breakdown-row">
                        <div class="breakdown-pill subtle">üèòÔ∏è</div>
                        <div class="breakdown-details">
                          <span class="label">HOA dues</span>
                          <span class="hint">Monthly association fees</span>
                        </div>
                        <span class="value" id="breakdown_hoa">$0</span>
                      </div>
                      <div class="breakdown-row" id="breakdown_mi_row">
                        <div class="breakdown-pill subtle">üîí</div>
                        <div class="breakdown-details">
                          <span class="label">Mortgage insurance</span>
                          <span class="hint">Monthly MI/PMI payment</span>
                        </div>
                        <span class="value" id="breakdown_mi">$0</span>
                      </div>
                    </div>
                  </div>
                  <p class="breakdown-footnote">Adjust tax, insurance, and HOA values above to update your monthly payment across all slides.</p>
                </div>
              </div>
            </div>
            <div class="carousel-slide" data-card="amortization" role="group" aria-roledescription="slide" aria-label="Amortization & totals" aria-hidden="true" data-openai-component="amortization-section">
              <div class="slide-content tight">
                <header class="slide-header">
                  <h2>Amortization & totals</h2>
                  <p>Review lifetime costs and the first year of payments at a glance.</p>
                </header>
                <section class="section-block">
                  <div class="section-title">Lifetime totals</div>
                  <div class="totals-list" id="totalsBreakdown"></div>
                </section>
                <section class="section-block">
                  <div class="section-title">Schedule preview</div>
                  <div id="schedulePreview"></div>
                  <div class="schedule-note" id="scheduleNote"></div>
                </section>
              </div>
            </div>
          </div>
        </div>
        <button class="carousel-nav" id="cardNext" aria-label="Next card" aria-controls="resultTrack">&#x203A;</button>
      </section>
    </div>

    <script type="module">
      (function () {
        const MONTHS_IN_YEAR = 12;
        const ZERO_TOLERANCE = 1e-8;

        const toNumber = (value) => {
          const num = Number(value);
          return Number.isFinite(num) ? num : 0;
        };

        const clampNonNegative = (value) => {
          const num = toNumber(value);
          return num < 0 ? 0 : num;
        };

        const normalizeMonth = (month) => {
          const m = Math.round(toNumber(month));
          if (Number.isNaN(m) || m <= 0) return 1;
          if (m > 12) {
            return ((m - 1) % 12) + 1;
          }
          return m;
        };

        const normalizeYear = (year) => {
          const y = Math.round(toNumber(year));
          return y > 0 ? y : new Date().getFullYear();
        };

        function compute_base_loan_amount(home_value, down_payment_value, down_payment_pct) {
          const hv = clampNonNegative(home_value);
          const dpValueInput = toNumber(down_payment_value);
          const dpPctInput = clampNonNegative(down_payment_pct);

          let loan_amount_base;
          let effectiveDpValue;
          let effectiveDpPct;

          // If both down payment fields provided, prefer down_payment_value
          if (dpValueInput > 0) {
            effectiveDpValue = Math.min(dpValueInput, hv); // Don't allow down payment > home value
            loan_amount_base = hv - effectiveDpValue;
            effectiveDpPct = hv > 0 ? effectiveDpValue / hv : 0;
          } else {
            effectiveDpPct = Math.min(dpPctInput, 1.0); // Don't allow down payment % > 100%
            effectiveDpValue = hv * effectiveDpPct;
            loan_amount_base = hv * (1 - effectiveDpPct);
          }

          return {
            loan_amount_base: clampNonNegative(loan_amount_base),
            down_payment_value: effectiveDpValue,
            down_payment_pct: effectiveDpPct,
          };
        }

        function apply_upfront_fee(loan_amount_base, upfront_fee_pct, finance_upfront_fee) {
          const base = clampNonNegative(loan_amount_base);
          const feePct = clampNonNegative(upfront_fee_pct);
          const upfront_fee = base * feePct;
          const financed = Boolean(finance_upfront_fee);
          const principal_0 = financed ? base + upfront_fee : base;
          const cash_at_close_upfront_fee = financed ? 0 : upfront_fee;

          return {
            principal_0,
            upfront_fee,
            cash_at_close_upfront_fee,
          };
        }

        function normalize_property_tax(property_tax_input, home_value) {
          const hv = clampNonNegative(home_value);
          const input = clampNonNegative(property_tax_input);

          if (input <= 20) {
            return {
              property_tax_yearly: hv * (input / 100),
              property_tax_mode: "percent",
            };
          }

          return {
            property_tax_yearly: input,
            property_tax_mode: "absolute",
          };
        }

        function monthly_p_and_i(principal_0, rate_apr, term_years) {
          const principal = clampNonNegative(principal_0);
          const termYears = clampNonNegative(term_years);
          const n = Math.max(Math.round(termYears * MONTHS_IN_YEAR), 0);

          if (n === 0 || principal === 0) {
            return 0;
          }

          const yearlyRate = clampNonNegative(rate_apr);
          const i_m = yearlyRate / MONTHS_IN_YEAR;

          if (i_m > 0) {
            const denominator = 1 - Math.pow(1 + i_m, -n);
            if (denominator === 0) {
              return principal / n;
            }
            return principal * i_m / denominator;
          } else {
            return principal / n;
          }
        }

        function monthly_mi(principal_t, loan_type, home_value, pmi_pct, annual_mi_pct) {
          const principal = clampNonNegative(principal_t);
          const hv = clampNonNegative(home_value);

          switch (loan_type) {
            case "conventional":
              if (hv === 0) return 0;
              const ltv = principal / hv;
              if (ltv <= 0.8) return 0;
              return (clampNonNegative(pmi_pct) / MONTHS_IN_YEAR) * principal;

            case "FHA":
              return (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR) * principal;

            case "VA":
              return 0;

            case "USDA":
              return (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR) * principal;

            default:
              return 0;
          }
        }

        const createStartDate = (start_month, start_year) =>
          new Date(normalizeYear(start_year), normalizeMonth(start_month) - 1, 1);

        const advanceOneMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 1);

        function amortize_monthly(
          principal_0,
          i_m,
          n,
          start_month,
          start_year,
          tax_monthly,
          ins_monthly,
          hoa_monthly,
          home_value,
          loan_type,
          pmi_pct,
          annual_mi_pct,
          p_and_i,
          extra_principal_monthly = 0,
          extra_start_month_index = 0
        ) {
          let principal = clampNonNegative(principal_0);
          let currentDate = createStartDate(start_month, start_year);
          const totalPeriods = Math.max(Math.round(toNumber(n)), 0);
          const extraStartIndex = Math.max(Math.round(toNumber(extra_start_month_index)), 0);

          const totals = {
            interest: 0,
            tax: 0,
            ins: 0,
            hoa: 0,
            mi: 0,
            principal: 0,
            payments: 0,
          };

          const schedule = [];

          for (let t = 0; t < totalPeriods && principal > ZERO_TOLERANCE; t += 1) {
            const interest = principal * clampNonNegative(i_m);
            const principal_sched = Math.max(p_and_i - interest, 0);

            const mi = monthly_mi(principal, loan_type, home_value, pmi_pct, annual_mi_pct);

            const tax = clampNonNegative(tax_monthly);
            const ins = clampNonNegative(ins_monthly);
            const hoa_v = clampNonNegative(hoa_monthly);

            const extra = t >= extraStartIndex ? clampNonNegative(extra_principal_monthly) : 0;

            const principal_reduction = principal_sched + extra;
            const principal_next = Math.max(principal - principal_reduction, 0);

            totals.interest += interest;
            totals.tax += tax;
            totals.ins += ins;
            totals.hoa += hoa_v;
            totals.mi += mi;
            totals.principal += principal_reduction;
            totals.payments += p_and_i + mi + tax + ins + hoa_v + extra;

            schedule.push({
              index: t,
              date: {
                year: currentDate.getFullYear(),
                month: currentDate.getMonth() + 1,
              },
              opening_balance: principal,
              p_and_i,
              interest,
              principal_scheduled: principal_sched,
              extra_principal: extra,
              mi,
              tax,
              ins,
              hoa: hoa_v,
              total_payment: p_and_i + mi + tax + ins + hoa_v + extra,
              closing_balance: principal_next,
            });

            principal = principal_next;
            currentDate = advanceOneMonth(currentDate);

            if (principal <= ZERO_TOLERANCE) {
              principal = 0;
              break;
            }
          }

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : {
                year: normalizeYear(start_year),
                month: normalizeMonth(start_month),
              };

          return { schedule, payoff_date, totals };
        }

        function summarize_outputs(schedule, totals, p_and_i, tax_monthly, ins_monthly, hoa, principal_0, mi0) {
          const total_monthly_0 = p_and_i + tax_monthly + ins_monthly + hoa + mi0;

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : null;

          return {
            total_monthly_0,
            payoff_date,
            total_interest: totals.interest,
            total_tax: totals.tax,
            total_ins: totals.ins,
            total_hoa: totals.hoa,
            total_mi: totals.mi,
            total_of_payments: totals.payments,
            total_principal: totals.principal,
            payments_made: schedule.length,
            schedule,
          };
        }

        function calculate_mortgage(params) {
          const {
            loan_type,
            home_value,
            down_payment_value,
            down_payment_pct,
            rate_apr,
            term_years,
            start_month,
            start_year,
            property_tax_input,
            homeowners_insurance_yearly,
            hoa_monthly,
            upfront_fee_pct,
            annual_mi_pct,
            finance_upfront_fee,
            extra_principal_monthly,
            extra_start_month_index,
            pmi_pct,
          } = params;

          const baseLoan = compute_base_loan_amount(home_value, down_payment_value, down_payment_pct);
          const feeResult = apply_upfront_fee(
            baseLoan.loan_amount_base,
            clampNonNegative(upfront_fee_pct),
            finance_upfront_fee
          );
          const taxInfo = normalize_property_tax(property_tax_input, home_value);

          const tax_monthly = taxInfo.property_tax_yearly / MONTHS_IN_YEAR;
          const ins_monthly = clampNonNegative(homeowners_insurance_yearly) / MONTHS_IN_YEAR;
          const hoa = clampNonNegative(hoa_monthly);
          const n = Math.max(Math.round(clampNonNegative(term_years) * MONTHS_IN_YEAR), 0);
          const i_m = clampNonNegative(rate_apr) / MONTHS_IN_YEAR;
          const p_and_i = monthly_p_and_i(feeResult.principal_0, rate_apr, term_years);

          const loanType = typeof loan_type === "string" ? loan_type : "conventional";
          const pmiPct = clampNonNegative(pmi_pct);
          const annualMiPct = clampNonNegative(annual_mi_pct);

          const amortization = amortize_monthly(
            feeResult.principal_0,
            i_m,
            n,
            start_month,
            start_year,
            tax_monthly,
            ins_monthly,
            hoa,
            home_value,
            loanType,
            pmiPct,
            annualMiPct,
            p_and_i,
            extra_principal_monthly,
            extra_start_month_index
          );

          const monthly_mi_initial = monthly_mi(feeResult.principal_0, loanType, home_value, pmiPct, annualMiPct);

          const totalsSummary = summarize_outputs(
            amortization.schedule,
            amortization.totals,
            p_and_i,
            tax_monthly,
            ins_monthly,
            hoa,
            feeResult.principal_0,
            monthly_mi_initial
          );

          return {
            inputs: {
              loan_type: loanType,
              home_value: clampNonNegative(home_value),
              down_payment_value: baseLoan.down_payment_value,
              down_payment_pct: baseLoan.down_payment_pct,
              rate_apr: clampNonNegative(rate_apr),
              term_years: clampNonNegative(term_years),
              start_month: normalizeMonth(start_month),
              start_year: normalizeYear(start_year),
              property_tax_input: clampNonNegative(property_tax_input),
              homeowners_insurance_yearly: clampNonNegative(homeowners_insurance_yearly),
              hoa_monthly: hoa,
              upfront_fee_pct: clampNonNegative(upfront_fee_pct),
              annual_mi_pct: annualMiPct,
              finance_upfront_fee: Boolean(finance_upfront_fee),
              extra_principal_monthly: clampNonNegative(extra_principal_monthly),
              extra_start_month_index: Math.max(Math.round(toNumber(extra_start_month_index)), 0),
              pmi_pct: pmiPct,
            },
            derived: {
              loan_amount_base: baseLoan.loan_amount_base,
              principal_0: feeResult.principal_0,
              upfront_fee: feeResult.upfront_fee,
              cash_at_close_upfront_fee: feeResult.cash_at_close_upfront_fee,
              property_tax_yearly: taxInfo.property_tax_yearly,
              property_tax_mode: taxInfo.property_tax_mode,
              tax_monthly,
              ins_monthly,
              hoa_monthly: hoa,
              p_and_i,
              monthly_mi_initial,
              total_monthly_0: totalsSummary.total_monthly_0,
            },
            payoff_date: totalsSummary.payoff_date,
            totals: {
              total_interest: totalsSummary.total_interest,
              total_tax: totalsSummary.total_tax,
              total_ins: totalsSummary.total_ins,
              total_hoa: totalsSummary.total_hoa,
              total_mi: totalsSummary.total_mi,
              total_of_payments: totalsSummary.total_of_payments,
              total_principal: totalsSummary.total_principal,
              payments_made: totalsSummary.payments_made,
            },
            schedule: totalsSummary.schedule,
          };
        }

        const mortgageCalculator = Object.freeze({
          compute_base_loan_amount,
          apply_upfront_fee,
          normalize_property_tax,
          monthly_p_and_i,
          monthly_mi,
          amortize_monthly,
          summarize_outputs,
          calculate_mortgage,
        });

        globalThis.mortgageCalculator = mortgageCalculator;

        const $ = (id) => document.getElementById(id);
        const formatCurrency = (value) =>
          clampNonNegative(value).toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
          });

        const formatCompactCurrency = (value) =>
          clampNonNegative(value).toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
            notation: "compact",
          });

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        const baseDefaults = {
          loan_type: "conventional",
          home_value: 450000,
          down_payment_value: 90000,
          rate_apr: 6.75,
          term_years: 30,
          start_month: 2,
          start_year: new Date().getFullYear(),
          property_tax_input: 1.05,
          homeowners_insurance_yearly: 1500,
          hoa_monthly: 0,
          upfront_fee_pct: 0,
          annual_mi_pct: 0,
          finance_upfront_fee: false,
          extra_principal_monthly: 0,
          extra_start_month_index: 0,
          pmi_pct: 0.5,
        };

        const programDefaults = {
          conventional: { pmi_pct: 0.5, upfront_fee_pct: 0, annual_mi_pct: 0, finance_upfront_fee: false },
          FHA: { pmi_pct: 0, upfront_fee_pct: 1.75, annual_mi_pct: 0.85, finance_upfront_fee: true },
          VA: { pmi_pct: 0, upfront_fee_pct: 2.3, annual_mi_pct: 0, finance_upfront_fee: true },
          USDA: { pmi_pct: 0, upfront_fee_pct: 1.0, annual_mi_pct: 0.35, finance_upfront_fee: true },
        };

        const inputs = {
          loan_type: $("loan_type"),
          home_value: $("home_value"),
          down_payment_value: $("down_payment_value"),
          rate_apr: $("rate_apr"),
          term_years: $("term_years"),
          start_month: $("start_month"),
          start_year: $("start_year"),
          zip_code: $("zip_code"),
          property_tax_input: $("property_tax_input"),
          homeowners_insurance_yearly: $("homeowners_insurance_yearly"),
          hoa_monthly: $("hoa_monthly"),
          pmi_pct: $("pmi_pct"),
          upfront_fee_pct: $("upfront_fee_pct"),
          annual_mi_pct: $("annual_mi_pct"),
          finance_upfront_fee: $("finance_upfront_fee"),
          va_disabled_veteran: $("va_disabled_veteran"),
          extra_principal_monthly: $("extra_principal_monthly"),
          extra_start_month_index: $("extra_start_month_index"),
        };

        // State-based property tax rates (annual % of home value) and insurance estimates
        const stateEstimates = {
          // Format: { taxRate: annual % of home value, insurancePercentOfValue: annual % for insurance }
          AL: { taxRate: 0.41, insurancePct: 0.35 }, AK: { taxRate: 1.19, insurancePct: 0.40 },
          AZ: { taxRate: 0.62, insurancePct: 0.30 }, AR: { taxRate: 0.62, insurancePct: 0.45 },
          CA: { taxRate: 0.76, insurancePct: 0.25 }, CO: { taxRate: 0.51, insurancePct: 0.30 },
          CT: { taxRate: 2.14, insurancePct: 0.30 }, DE: { taxRate: 0.57, insurancePct: 0.25 },
          FL: { taxRate: 0.89, insurancePct: 0.60 }, GA: { taxRate: 0.92, insurancePct: 0.35 },
          HI: { taxRate: 0.28, insurancePct: 0.20 }, ID: { taxRate: 0.69, insurancePct: 0.28 },
          IL: { taxRate: 2.27, insurancePct: 0.30 }, IN: { taxRate: 0.85, insurancePct: 0.28 },
          IA: { taxRate: 1.57, insurancePct: 0.32 }, KS: { taxRate: 1.41, insurancePct: 0.40 },
          KY: { taxRate: 0.86, insurancePct: 0.35 }, LA: { taxRate: 0.55, insurancePct: 0.65 },
          ME: { taxRate: 1.36, insurancePct: 0.28 }, MD: { taxRate: 1.09, insurancePct: 0.25 },
          MA: { taxRate: 1.23, insurancePct: 0.28 }, MI: { taxRate: 1.54, insurancePct: 0.28 },
          MN: { taxRate: 1.12, insurancePct: 0.32 }, MS: { taxRate: 0.81, insurancePct: 0.55 },
          MO: { taxRate: 0.97, insurancePct: 0.38 }, MT: { taxRate: 0.84, insurancePct: 0.35 },
          NE: { taxRate: 1.73, insurancePct: 0.40 }, NV: { taxRate: 0.60, insurancePct: 0.28 },
          NH: { taxRate: 2.18, insurancePct: 0.28 }, NJ: { taxRate: 2.49, insurancePct: 0.28 },
          NM: { taxRate: 0.80, insurancePct: 0.35 }, NY: { taxRate: 1.72, insurancePct: 0.30 },
          NC: { taxRate: 0.84, insurancePct: 0.32 }, ND: { taxRate: 0.98, insurancePct: 0.38 },
          OH: { taxRate: 1.56, insurancePct: 0.28 }, OK: { taxRate: 0.90, insurancePct: 0.55 },
          OR: { taxRate: 0.97, insurancePct: 0.25 }, PA: { taxRate: 1.58, insurancePct: 0.28 },
          RI: { taxRate: 1.63, insurancePct: 0.32 }, SC: { taxRate: 0.57, insurancePct: 0.42 },
          SD: { taxRate: 1.31, insurancePct: 0.38 }, TN: { taxRate: 0.71, insurancePct: 0.35 },
          TX: { taxRate: 1.80, insurancePct: 0.50 }, UT: { taxRate: 0.63, insurancePct: 0.28 },
          VT: { taxRate: 1.90, insurancePct: 0.30 }, VA: { taxRate: 0.82, insurancePct: 0.25 },
          WA: { taxRate: 0.98, insurancePct: 0.25 }, WV: { taxRate: 0.58, insurancePct: 0.32 },
          WI: { taxRate: 1.85, insurancePct: 0.28 }, WY: { taxRate: 0.61, insurancePct: 0.35 },
          DC: { taxRate: 0.56, insurancePct: 0.22 },
        };

        // ZIP code prefix to state mapping (first 3 digits)
        const zipToState = {
          '005': 'NY', '006': 'PR', '007': 'PR', '008': 'PR', '009': 'PR',
          '010': 'MA', '011': 'MA', '012': 'MA', '013': 'MA', '014': 'MA', '015': 'MA', '016': 'MA', '017': 'MA', '018': 'MA', '019': 'MA', '020': 'MA', '021': 'MA', '022': 'MA', '023': 'MA', '024': 'MA', '025': 'MA', '026': 'MA', '027': 'MA',
          '028': 'RI', '029': 'RI',
          '030': 'NH', '031': 'NH', '032': 'NH', '033': 'NH', '034': 'NH', '035': 'NH', '036': 'NH', '037': 'NH', '038': 'NH',
          '039': 'ME', '040': 'ME', '041': 'ME', '042': 'ME', '043': 'ME', '044': 'ME', '045': 'ME', '046': 'ME', '047': 'ME', '048': 'ME', '049': 'ME',
          '050': 'VT', '051': 'VT', '052': 'VT', '053': 'VT', '054': 'VT', '055': 'VT', '056': 'VT', '057': 'VT', '058': 'VT', '059': 'VT',
          '060': 'CT', '061': 'CT', '062': 'CT', '063': 'CT', '064': 'CT', '065': 'CT', '066': 'CT', '067': 'CT', '068': 'CT', '069': 'CT',
          '070': 'NJ', '071': 'NJ', '072': 'NJ', '073': 'NJ', '074': 'NJ', '075': 'NJ', '076': 'NJ', '077': 'NJ', '078': 'NJ', '079': 'NJ', '080': 'NJ', '081': 'NJ', '082': 'NJ', '083': 'NJ', '084': 'NJ', '085': 'NJ', '086': 'NJ', '087': 'NJ', '088': 'NJ', '089': 'NJ',
          '100': 'NY', '101': 'NY', '102': 'NY', '103': 'NY', '104': 'NY', '105': 'NY', '106': 'NY', '107': 'NY', '108': 'NY', '109': 'NY', '110': 'NY', '111': 'NY', '112': 'NY', '113': 'NY', '114': 'NY', '115': 'NY', '116': 'NY', '117': 'NY', '118': 'NY', '119': 'NY', '120': 'NY', '121': 'NY', '122': 'NY', '123': 'NY', '124': 'NY', '125': 'NY', '126': 'NY', '127': 'NY', '128': 'NY', '129': 'NY', '130': 'NY', '131': 'NY', '132': 'NY', '133': 'NY', '134': 'NY', '135': 'NY', '136': 'NY', '137': 'NY', '138': 'NY', '139': 'NY', '140': 'NY', '141': 'NY', '142': 'NY', '143': 'NY', '144': 'NY', '145': 'NY', '146': 'NY', '147': 'NY', '148': 'NY', '149': 'NY',
          '150': 'PA', '151': 'PA', '152': 'PA', '153': 'PA', '154': 'PA', '155': 'PA', '156': 'PA', '157': 'PA', '158': 'PA', '159': 'PA', '160': 'PA', '161': 'PA', '162': 'PA', '163': 'PA', '164': 'PA', '165': 'PA', '166': 'PA', '167': 'PA', '168': 'PA', '169': 'PA', '170': 'PA', '171': 'PA', '172': 'PA', '173': 'PA', '174': 'PA', '175': 'PA', '176': 'PA', '177': 'PA', '178': 'PA', '179': 'PA', '180': 'PA', '181': 'PA', '182': 'PA', '183': 'PA', '184': 'PA', '185': 'PA', '186': 'PA', '187': 'PA', '188': 'PA', '189': 'PA', '190': 'PA', '191': 'PA', '192': 'PA', '193': 'PA', '194': 'PA', '195': 'PA', '196': 'PA',
          '197': 'DE', '198': 'DE', '199': 'DE',
          '200': 'DC', '201': 'VA', '202': 'DC', '203': 'DC', '204': 'DC', '205': 'DC',
          '206': 'MD', '207': 'MD', '208': 'MD', '209': 'MD', '210': 'MD', '211': 'MD', '212': 'MD', '214': 'MD', '215': 'MD', '216': 'MD', '217': 'MD', '218': 'MD', '219': 'MD',
          '220': 'VA', '221': 'VA', '222': 'VA', '223': 'VA', '224': 'VA', '225': 'VA', '226': 'VA', '227': 'VA', '228': 'VA', '229': 'VA', '230': 'VA', '231': 'VA', '232': 'VA', '233': 'VA', '234': 'VA', '235': 'VA', '236': 'VA', '237': 'VA', '238': 'VA', '239': 'VA', '240': 'VA', '241': 'VA', '242': 'VA', '243': 'VA', '244': 'VA', '245': 'VA', '246': 'VA',
          '247': 'WV', '248': 'WV', '249': 'WV', '250': 'WV', '251': 'WV', '252': 'WV', '253': 'WV', '254': 'WV', '255': 'WV', '256': 'WV', '257': 'WV', '258': 'WV', '259': 'WV', '260': 'WV', '261': 'WV', '262': 'WV', '263': 'WV', '264': 'WV', '265': 'WV', '266': 'WV', '267': 'WV', '268': 'WV',
          '270': 'NC', '271': 'NC', '272': 'NC', '273': 'NC', '274': 'NC', '275': 'NC', '276': 'NC', '277': 'NC', '278': 'NC', '279': 'NC', '280': 'NC', '281': 'NC', '282': 'NC', '283': 'NC', '284': 'NC', '285': 'NC', '286': 'NC', '287': 'NC', '288': 'NC', '289': 'NC',
          '290': 'SC', '291': 'SC', '292': 'SC', '293': 'SC', '294': 'SC', '295': 'SC', '296': 'SC', '297': 'SC', '298': 'SC', '299': 'SC',
          '300': 'GA', '301': 'GA', '302': 'GA', '303': 'GA', '304': 'GA', '305': 'GA', '306': 'GA', '307': 'GA', '308': 'GA', '309': 'GA', '310': 'GA', '311': 'GA', '312': 'GA', '313': 'GA', '314': 'GA', '315': 'GA', '316': 'GA', '317': 'GA', '318': 'GA', '319': 'GA',
          '320': 'FL', '321': 'FL', '322': 'FL', '323': 'FL', '324': 'FL', '325': 'FL', '326': 'FL', '327': 'FL', '328': 'FL', '329': 'FL', '330': 'FL', '331': 'FL', '332': 'FL', '333': 'FL', '334': 'FL', '335': 'FL', '336': 'FL', '337': 'FL', '338': 'FL', '339': 'FL', '340': 'FL', '341': 'FL', '342': 'FL', '344': 'FL', '346': 'FL', '347': 'FL', '349': 'FL',
          '350': 'AL', '351': 'AL', '352': 'AL', '354': 'AL', '355': 'AL', '356': 'AL', '357': 'AL', '358': 'AL', '359': 'AL', '360': 'AL', '361': 'AL', '362': 'AL', '363': 'AL', '364': 'AL', '365': 'AL', '366': 'AL', '367': 'AL', '368': 'AL', '369': 'AL',
          '370': 'TN', '371': 'TN', '372': 'TN', '373': 'TN', '374': 'TN', '375': 'TN', '376': 'TN', '377': 'TN', '378': 'TN', '379': 'TN', '380': 'TN', '381': 'TN', '382': 'TN', '383': 'TN', '384': 'TN', '385': 'TN',
          '386': 'MS', '387': 'MS', '388': 'MS', '389': 'MS', '390': 'MS', '391': 'MS', '392': 'MS', '393': 'MS', '394': 'MS', '395': 'MS', '396': 'MS', '397': 'MS',
          '400': 'KY', '401': 'KY', '402': 'KY', '403': 'KY', '404': 'KY', '405': 'KY', '406': 'KY', '407': 'KY', '408': 'KY', '409': 'KY', '410': 'KY', '411': 'KY', '412': 'KY', '413': 'KY', '414': 'KY', '415': 'KY', '416': 'KY', '417': 'KY', '418': 'KY', '420': 'KY', '421': 'KY', '422': 'KY', '423': 'KY', '424': 'KY', '425': 'KY', '426': 'KY', '427': 'KY',
          '430': 'OH', '431': 'OH', '432': 'OH', '433': 'OH', '434': 'OH', '435': 'OH', '436': 'OH', '437': 'OH', '438': 'OH', '439': 'OH', '440': 'OH', '441': 'OH', '442': 'OH', '443': 'OH', '444': 'OH', '445': 'OH', '446': 'OH', '447': 'OH', '448': 'OH', '449': 'OH', '450': 'OH', '451': 'OH', '452': 'OH', '453': 'OH', '454': 'OH', '455': 'OH', '456': 'OH', '457': 'OH', '458': 'OH',
          '460': 'IN', '461': 'IN', '462': 'IN', '463': 'IN', '464': 'IN', '465': 'IN', '466': 'IN', '467': 'IN', '468': 'IN', '469': 'IN', '470': 'IN', '471': 'IN', '472': 'IN', '473': 'IN', '474': 'IN', '475': 'IN', '476': 'IN', '477': 'IN', '478': 'IN', '479': 'IN',
          '480': 'MI', '481': 'MI', '482': 'MI', '483': 'MI', '484': 'MI', '485': 'MI', '486': 'MI', '487': 'MI', '488': 'MI', '489': 'MI', '490': 'MI', '491': 'MI', '492': 'MI', '493': 'MI', '494': 'MI', '495': 'MI', '496': 'MI', '497': 'MI', '498': 'MI', '499': 'MI',
          '500': 'IA', '501': 'IA', '502': 'IA', '503': 'IA', '504': 'IA', '505': 'IA', '506': 'IA', '507': 'IA', '508': 'IA', '509': 'IA', '510': 'IA', '511': 'IA', '512': 'IA', '513': 'IA', '514': 'IA', '515': 'IA', '516': 'IA', '520': 'IA', '521': 'IA', '522': 'IA', '523': 'IA', '524': 'IA', '525': 'IA', '526': 'IA', '527': 'IA', '528': 'IA',
          '530': 'WI', '531': 'WI', '532': 'WI', '534': 'WI', '535': 'WI', '537': 'WI', '538': 'WI', '539': 'WI', '540': 'WI', '541': 'WI', '542': 'WI', '543': 'WI', '544': 'WI', '545': 'WI', '546': 'WI', '547': 'WI', '548': 'WI', '549': 'WI',
          '550': 'MN', '551': 'MN', '553': 'MN', '554': 'MN', '555': 'MN', '556': 'MN', '557': 'MN', '558': 'MN', '559': 'MN', '560': 'MN', '561': 'MN', '562': 'MN', '563': 'MN', '564': 'MN', '565': 'MN', '566': 'MN', '567': 'MN',
          '570': 'SD', '571': 'SD', '572': 'SD', '573': 'SD', '574': 'SD', '575': 'SD', '576': 'SD', '577': 'SD',
          '580': 'ND', '581': 'ND', '582': 'ND', '583': 'ND', '584': 'ND', '585': 'ND', '586': 'ND', '587': 'ND', '588': 'ND',
          '590': 'MT', '591': 'MT', '592': 'MT', '593': 'MT', '594': 'MT', '595': 'MT', '596': 'MT', '597': 'MT', '598': 'MT', '599': 'MT',
          '600': 'IL', '601': 'IL', '602': 'IL', '603': 'IL', '604': 'IL', '605': 'IL', '606': 'IL', '607': 'IL', '608': 'IL', '609': 'IL', '610': 'IL', '611': 'IL', '612': 'IL', '613': 'IL', '614': 'IL', '615': 'IL', '616': 'IL', '617': 'IL', '618': 'IL', '619': 'IL', '620': 'IL', '622': 'IL', '623': 'IL', '624': 'IL', '625': 'IL', '626': 'IL', '627': 'IL', '628': 'IL', '629': 'IL',
          '630': 'MO', '631': 'MO', '633': 'MO', '634': 'MO', '635': 'MO', '636': 'MO', '637': 'MO', '638': 'MO', '639': 'MO', '640': 'MO', '641': 'MO', '644': 'MO', '645': 'MO', '646': 'MO', '647': 'MO', '648': 'MO', '649': 'MO', '650': 'MO', '651': 'MO', '652': 'MO', '653': 'MO', '654': 'MO', '655': 'MO', '656': 'MO', '657': 'MO', '658': 'MO',
          '660': 'KS', '661': 'KS', '662': 'KS', '664': 'KS', '665': 'KS', '666': 'KS', '667': 'KS', '668': 'KS', '669': 'KS', '670': 'KS', '671': 'KS', '672': 'KS', '673': 'KS', '674': 'KS', '675': 'KS', '676': 'KS', '677': 'KS', '678': 'KS', '679': 'KS',
          '680': 'NE', '681': 'NE', '683': 'NE', '684': 'NE', '685': 'NE', '686': 'NE', '687': 'NE', '688': 'NE', '689': 'NE', '690': 'NE', '691': 'NE', '692': 'NE', '693': 'NE',
          '700': 'LA', '701': 'LA', '703': 'LA', '704': 'LA', '705': 'LA', '706': 'LA', '707': 'LA', '708': 'LA', '710': 'LA', '711': 'LA', '712': 'LA', '713': 'LA', '714': 'LA',
          '716': 'AR', '717': 'AR', '718': 'AR', '719': 'AR', '720': 'AR', '721': 'AR', '722': 'AR', '723': 'AR', '724': 'AR', '725': 'AR', '726': 'AR', '727': 'AR', '728': 'AR', '729': 'AR',
          '730': 'OK', '731': 'OK', '734': 'OK', '735': 'OK', '736': 'OK', '737': 'OK', '738': 'OK', '739': 'OK', '740': 'OK', '741': 'OK', '743': 'OK', '744': 'OK', '745': 'OK', '746': 'OK', '747': 'OK', '748': 'OK', '749': 'OK',
          '750': 'TX', '751': 'TX', '752': 'TX', '753': 'TX', '754': 'TX', '755': 'TX', '756': 'TX', '757': 'TX', '758': 'TX', '759': 'TX', '760': 'TX', '761': 'TX', '762': 'TX', '763': 'TX', '764': 'TX', '765': 'TX', '766': 'TX', '767': 'TX', '768': 'TX', '769': 'TX', '770': 'TX', '771': 'TX', '772': 'TX', '773': 'TX', '774': 'TX', '775': 'TX', '776': 'TX', '777': 'TX', '778': 'TX', '779': 'TX', '780': 'TX', '781': 'TX', '782': 'TX', '783': 'TX', '784': 'TX', '785': 'TX', '786': 'TX', '787': 'TX', '788': 'TX', '789': 'TX', '790': 'TX', '791': 'TX', '792': 'TX', '793': 'TX', '794': 'TX', '795': 'TX', '796': 'TX', '797': 'TX', '798': 'TX', '799': 'TX',
          '800': 'CO', '801': 'CO', '802': 'CO', '803': 'CO', '804': 'CO', '805': 'CO', '806': 'CO', '807': 'CO', '808': 'CO', '809': 'CO', '810': 'CO', '811': 'CO', '812': 'CO', '813': 'CO', '814': 'CO', '815': 'CO', '816': 'CO',
          '820': 'WY', '821': 'WY', '822': 'WY', '823': 'WY', '824': 'WY', '825': 'WY', '826': 'WY', '827': 'WY', '828': 'WY', '829': 'WY', '830': 'WY', '831': 'WY',
          '832': 'ID', '833': 'ID', '834': 'ID', '835': 'ID', '836': 'ID', '837': 'ID', '838': 'ID',
          '840': 'UT', '841': 'UT', '842': 'UT', '843': 'UT', '844': 'UT', '845': 'UT', '846': 'UT', '847': 'UT',
          '850': 'AZ', '851': 'AZ', '852': 'AZ', '853': 'AZ', '855': 'AZ', '856': 'AZ', '857': 'AZ', '859': 'AZ', '860': 'AZ', '863': 'AZ', '864': 'AZ', '865': 'AZ',
          '870': 'NM', '871': 'NM', '872': 'NM', '873': 'NM', '874': 'NM', '875': 'NM', '877': 'NM', '878': 'NM', '879': 'NM', '880': 'NM', '881': 'NM', '882': 'NM', '883': 'NM', '884': 'NM',
          '889': 'NV', '890': 'NV', '891': 'NV', '893': 'NV', '894': 'NV', '895': 'NV', '897': 'NV', '898': 'NV',
          '900': 'CA', '901': 'CA', '902': 'CA', '903': 'CA', '904': 'CA', '905': 'CA', '906': 'CA', '907': 'CA', '908': 'CA', '910': 'CA', '911': 'CA', '912': 'CA', '913': 'CA', '914': 'CA', '915': 'CA', '916': 'CA', '917': 'CA', '918': 'CA', '919': 'CA', '920': 'CA', '921': 'CA', '922': 'CA', '923': 'CA', '924': 'CA', '925': 'CA', '926': 'CA', '927': 'CA', '928': 'CA', '930': 'CA', '931': 'CA', '932': 'CA', '933': 'CA', '934': 'CA', '935': 'CA', '936': 'CA', '937': 'CA', '938': 'CA', '939': 'CA', '940': 'CA', '941': 'CA', '942': 'CA', '943': 'CA', '944': 'CA', '945': 'CA', '946': 'CA', '947': 'CA', '948': 'CA', '949': 'CA', '950': 'CA', '951': 'CA', '952': 'CA', '953': 'CA', '954': 'CA', '955': 'CA', '956': 'CA', '957': 'CA', '958': 'CA', '959': 'CA', '960': 'CA', '961': 'CA',
          '967': 'HI', '968': 'HI',
          '970': 'OR', '971': 'OR', '972': 'OR', '973': 'OR', '974': 'OR', '975': 'OR', '976': 'OR', '977': 'OR', '978': 'OR', '979': 'OR',
          '980': 'WA', '981': 'WA', '982': 'WA', '983': 'WA', '984': 'WA', '985': 'WA', '986': 'WA', '988': 'WA', '989': 'WA', '990': 'WA', '991': 'WA', '992': 'WA', '993': 'WA', '994': 'WA',
          '995': 'AK', '996': 'AK', '997': 'AK', '998': 'AK', '999': 'AK',
        };

        const getStateFromZip = (zip) => {
          const cleaned = String(zip).replace(/\D/g, '').slice(0, 3).padStart(3, '0');
          return zipToState[cleaned] || null;
        };

        const estimateFromZipAndPrice = () => {
          const zip = inputs.zip_code?.value || '';
          const homeValue = toNumber(inputs.home_value.value);
          if (!zip || zip.length < 3 || homeValue <= 0) return;
          
          const state = getStateFromZip(zip);
          if (!state || !stateEstimates[state]) return;
          
          const est = stateEstimates[state];
          // Only update if user hasn't manually changed the values (check if they're at defaults or empty)
          const currentTax = toNumber(inputs.property_tax_input.value);
          const currentIns = toNumber(inputs.homeowners_insurance_yearly.value);
          
          // Update property tax rate (as percentage)
          if (currentTax === 0 || currentTax === 1.05) {
            inputs.property_tax_input.value = est.taxRate.toFixed(2);
          }
          
          // Update insurance estimate (as dollar amount)
          if (currentIns === 0 || currentIns === 1500) {
            const insuranceEstimate = Math.round(homeValue * (est.insurancePct / 100));
            inputs.homeowners_insurance_yearly.value = insuranceEstimate;
          }
        };

        const sliders = {
          down_payment: $("down_payment_slider"),
          rate: $("rate_slider"),
          term: $("term_slider"),
        };

        const sliderDisplays = {
          down_payment: $("down_payment_slider_display"),
          rate: $("rate_slider_display"),
          term: $("term_slider_display"),
        };

        const scenarioBar = document.getElementById("scenarioBar");
        let didUserEdit = false;

        const miVisibilityPrograms = new Set(["FHA", "USDA"]);
        const miOnlyElements = Array.from(document.querySelectorAll("[data-mi-only]"));

        const updateMiVisibility = () => {
          const program = inputs.loan_type.value;
          const show = miVisibilityPrograms.has(program);
          miOnlyElements.forEach((el) => {
            el.classList.toggle("is-hidden", !show);
          });
        };

        const vaDisabledVeteranRow = $("va_disabled_veteran_row");
        const updateVaDisabledVeteranVisibility = () => {
          const program = inputs.loan_type.value;
          const showVaOption = program === 'VA';
          if (vaDisabledVeteranRow) {
            vaDisabledVeteranRow.classList.toggle('is-hidden', !showVaOption);
          }
          // Reset checkbox when switching away from VA
          if (!showVaOption && inputs.va_disabled_veteran) {
            inputs.va_disabled_veteran.checked = false;
          }
        };

        const percentInputIds = ["rate_apr", "pmi_pct", "upfront_fee_pct", "annual_mi_pct"];
        const percentInputSet = new Set(percentInputIds);

        const formatPercentValue = (value) => {
          const num = toNumber(value);
          if (!Number.isFinite(num)) return "";
          return num.toFixed(2);
        };

        const normalizePercentInput = (el) => {
          if (!el) return;
          const formatted = formatPercentValue(el.value);
          if (formatted !== "") {
            el.value = formatted;
          }
        };

        const normalizePercentInputs = () => {
          percentInputIds.forEach((id) => normalizePercentInput(inputs[id]));
        };

        const outputs = {
          total_monthly_0: $("total_monthly_0"),
          p_and_i: $("p_and_i"),
          total_interest: $("total_interest"),
          payoff_date: $("payoff_date"),
          interest_hint: $("interest_hint"),
          term_hint: $("term_hint"),
          totalsBreakdown: $("totalsBreakdown"),
          schedulePreview: $("schedulePreview"),
          scheduleNote: $("scheduleNote"),
        };
        const monthlyPaymentCard = $("monthlyPaymentCard");
        const carousel = {
          track: $("resultTrack"),
          prev: $("cardPrev"),
          next: $("cardNext"),
          slides: Array.from(document.querySelectorAll(".carousel-slide")),
          index: 0,
        };
        const fieldMessages = Array.from(document.querySelectorAll(".field-message"));

        const clearFieldErrors = () => {
          fieldMessages.forEach((span) => {
            span.textContent = "";
            const label = span.closest("label");
            if (label) label.classList.remove("has-error");
          });
        };

        const setFieldError = (fieldId, message) => {
          const span = document.querySelector(`[data-field-error="${fieldId}"]`);
          if (!span) return;
          span.textContent = message;
          const label = span.closest("label");
          if (label) label.classList.add("has-error");
        };

        const emitTelemetry = (event, detail = {}) => {
          try {
            if (window?.openai?.trackEvent) {
              window.openai.trackEvent(event, detail);
              return;
            }
          } catch (err) {
            console.debug("trackEvent failed", err);
          }
          console.debug(`[mortgage-telemetry] ${event}`, detail);
        };

        // Lightweight toast notifications for success/failure messages
        const getToastContainer = () => {
          let el = document.querySelector('.toast-container');
          if (!el) {
            el = document.createElement('div');
            el.className = 'toast-container';
            document.body.appendChild(el);
          }
          return el;
        };
        const showToast = (type, message) => {
          const container = getToastContainer();
          const t = document.createElement('div');
          t.className = `toast ${type}`;
          t.textContent = message;
          container.appendChild(t);
          requestAnimationFrame(() => t.classList.add('show'));
          setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 250);
          }, 3000);
        };

        const validateInputs = () => {
          clearFieldErrors();
          const issues = [];

          const homeValue = toNumber(inputs.home_value.value);
          if (homeValue <= 0) {
            setFieldError("home_value", "Enter a home value above 0");
            issues.push("home_value");
          }

          const downPaymentValue = toNumber(inputs.down_payment_value.value);
          if (downPaymentValue < 0) {
            setFieldError("down_payment_value", "Cannot be negative");
            issues.push("down_payment_value");
          } else if (homeValue > 0 && downPaymentValue > homeValue) {
            setFieldError("down_payment_value", "Cannot exceed home value");
            issues.push("down_payment_value");
          }

          const rateApr = toNumber(inputs.rate_apr.value);
          if (rateApr < 0) {
            setFieldError("rate_apr", "Rate cannot be negative");
            issues.push("rate_apr");
          }

          const termYears = toNumber(inputs.term_years.value);
          if (termYears < 1) {
            setFieldError("term_years", "Must be at least 1 year");
            issues.push("term_years");
          }

          const startMonth = toNumber(inputs.start_month.value);
          if (startMonth && (startMonth < 1 || startMonth > 12)) {
            setFieldError("start_month", "Use a month between 1 and 12");
            issues.push("start_month");
          }

          const startYear = toNumber(inputs.start_year.value);
          if (startYear && startYear < 1900) {
            setFieldError("start_year", "Year looks too early");
            issues.push("start_year");
          }

          if (issues.length) {
            emitTelemetry("validation_error", { fields: issues });
            return false;
          }

          return true;
        };

        const updateSliderPositions = () => {
          const hv = toNumber(inputs.home_value.value);
          if (sliders.down_payment) {
            const dpValue = toNumber(inputs.down_payment_value.value);
            const percent = hv > 0 ? Math.round((dpValue / hv) * 100) : 0;
            sliders.down_payment.value = String(Math.min(80, Math.max(0, percent)));
            if (sliderDisplays.down_payment) sliderDisplays.down_payment.textContent = `${sliders.down_payment.value}%`;
          }
          if (sliders.rate) {
            const rawRate = toNumber(inputs.rate_apr.value);
            sliders.rate.value = String(Math.min(12, Math.max(0, rawRate)));
            if (sliderDisplays.rate) sliderDisplays.rate.textContent = `${Number(sliders.rate.value).toFixed(2)}%`;
          }
          if (sliders.term) {
            const term = Math.round(toNumber(inputs.term_years.value) || 30);
            sliders.term.value = String(Math.min(40, Math.max(5, term)));
            if (sliderDisplays.term) sliderDisplays.term.textContent = `${sliders.term.value}y`;
          }
        };

        const setDefaults = (preset = baseDefaults) => {
          Object.entries(preset).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          normalizePercentInputs();
          updateMiVisibility();
          clearFieldErrors();
          updateSliderPositions();
        };

        const mergeProgramDefaults = () => {
          const program = inputs.loan_type.value;
          const defaults = programDefaults[program];
          if (!defaults) return;
          Object.entries(defaults).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              // Always update program-specific fields (pmi_pct, upfront_fee_pct, annual_mi_pct)
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          normalizePercentInputs();
        };

        const readParams = () => {
          const loanType = inputs.loan_type.value;
          const isVaDisabledVeteran = loanType === 'VA' && inputs.va_disabled_veteran?.checked;
          // Zero out upfront fee for disabled veterans with VA loans
          const upfrontFeePct = isVaDisabledVeteran ? 0 : toNumber(inputs.upfront_fee_pct.value) / 100;
          
          return {
            loan_type: loanType,
            home_value: toNumber(inputs.home_value.value),
            down_payment_value: toNumber(inputs.down_payment_value.value),
            down_payment_pct: 0,
            rate_apr: toNumber(inputs.rate_apr.value) / 100,
            term_years: toNumber(inputs.term_years.value),
            start_month: toNumber(inputs.start_month.value),
            start_year: toNumber(inputs.start_year.value),
            property_tax_input: toNumber(inputs.property_tax_input.value),
            homeowners_insurance_yearly: toNumber(inputs.homeowners_insurance_yearly.value),
            hoa_monthly: toNumber(inputs.hoa_monthly.value),
            upfront_fee_pct: upfrontFeePct,
            annual_mi_pct: toNumber(inputs.annual_mi_pct.value) / 100,
            finance_upfront_fee: Boolean(inputs.finance_upfront_fee.checked),
            extra_principal_monthly: toNumber(inputs.extra_principal_monthly.value),
            extra_start_month_index: toNumber(inputs.extra_start_month_index.value),
            pmi_pct: toNumber(inputs.pmi_pct.value) / 100,
          };
        };

        const divideSafe = (numerator, denominator) =>
          denominator === 0 ? 0 : numerator / denominator;

        const renderSummary = (calc) => {
          const { inputs: normalized, derived, totals, payoff_date } = calc;
          const monthsElapsed = totals.payments_made || 0;
          const yearsElapsed = divideSafe(monthsElapsed, 12);
          const payoffLabel = payoff_date
            ? `${monthNames[normalizeMonth(payoff_date.month) - 1]} ${payoff_date.year}`
            : "‚Äî";

          const monthlyPaymentEl = outputs.total_monthly_0;
          monthlyPaymentEl.textContent = formatCurrency(derived.total_monthly_0);
          if (monthlyPaymentCard) {
            monthlyPaymentCard.classList.remove("glow-animate");
            void monthlyPaymentCard.offsetWidth;
            monthlyPaymentCard.classList.add("glow-animate");
          }
          outputs.p_and_i.textContent = formatCurrency(derived.p_and_i);
          outputs.total_interest.textContent = formatCurrency(totals.total_interest);
          outputs.payoff_date.textContent = payoffLabel;

          const totalExtraPrincipal = calc.schedule.reduce((sum, row) => sum + row.extra_principal, 0);

          outputs.interest_hint.textContent = `Totals include ${formatCurrency(
            totals.total_principal - totalExtraPrincipal
          )} scheduled principal and ${formatCurrency(totalExtraPrincipal)} extra payments.`;

          outputs.term_hint.textContent = `Original term ${normalized.term_years} yrs ‚Äî paid off in ${yearsElapsed.toFixed(
            1
          )} yrs (${monthsElapsed} months).`;

          outputs.totalsBreakdown.innerHTML = `
            <div class="totals-item">
              <span class="label">Tax & insurance</span>
              <span class="value">${formatCurrency(totals.total_tax + totals.total_ins)}</span>
            </div>
            <div class="totals-item">
              <span class="label">Mortgage insurance</span>
              <span class="value">${formatCurrency(totals.total_mi)}</span>
            </div>
            <div class="totals-item">
              <span class="label">HOA dues</span>
              <span class="value">${formatCurrency(totals.total_hoa)}</span>
            </div>
            <div class="totals-item">
              <span class="label">Total paid</span>
              <span class="value">${formatCurrency(totals.total_of_payments)}</span>
            </div>
          `;

          const previewRows = calc.schedule.slice(0, 12);
          if (previewRows.length) {
            const rows = previewRows
              .map((row) => {
                const monthLabel = `${monthNames[row.date.month - 1].slice(0, 3)} ${row.date.year}`;
                return `
                  <tr>
                    <td class="label">${row.index + 1}</td>
                    <td>${monthLabel}</td>
                    <td>${formatCurrency(row.total_payment)}</td>
                    <td>${formatCurrency(row.principal_scheduled + row.extra_principal)}</td>
                    <td>${formatCurrency(row.interest)}</td>
                    <td>${formatCurrency(row.closing_balance)}</td>
                  </tr>`;
              })
              .join("");

            outputs.schedulePreview.innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th class="label">Month</th>
                    <th>Payment</th>
                    <th>Principal</th>
                    <th>Interest</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            `;
            outputs.scheduleNote.textContent = `Showing first ${previewRows.length} of ${calc.schedule.length} months.`;
          } else {
            outputs.schedulePreview.innerHTML = "";
            outputs.scheduleNote.textContent = "Enter loan details to view amortization.";
          }
        };

        const breakdownInputs = {
          tax: $("breakdown_tax_input"),
          ins: $("breakdown_ins_input"),
          hoa: $("breakdown_hoa_input"),
        };

        const breakdownOutputs = {
          p_and_i: $("breakdown_p_and_i"),
          tax: $("breakdown_tax"),
          ins: $("breakdown_ins"),
          hoa: $("breakdown_hoa"),
          mi: $("breakdown_mi"),
          mi_row: $("breakdown_mi_row"),
          chartTotal: $("chartTotal"),
          canvas: $("breakdownChart"),
        };

        const fitCanvasToParent = (canvas) => {
          const rect = canvas.getBoundingClientRect();
          const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
          const size = Math.max(140, Math.round(rect.width * dpr));
          if (canvas.width !== size || canvas.height !== size) {
            canvas.width = size;
            canvas.height = size;
          }
        };

        const drawDonutChart = (ctx, data, colors) => {
          const canvas = ctx.canvas;
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2;
          const radius = Math.min(canvas.width, canvas.height) * 0.42;
          const holeRadius = radius * 0.76;

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          const total = data.reduce((sum, val) => sum + val, 0);
          if (total === 0) return;

          let currentAngle = -Math.PI / 2;

          data.forEach((value, index) => {
            const sliceAngle = (value / total) * 2 * Math.PI;
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
            ctx.arc(centerX, centerY, holeRadius, currentAngle + sliceAngle, currentAngle, true);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(centerX - radius, centerY - radius, centerX + radius, centerY + radius);
            gradient.addColorStop(0, colors[index][0]);
            gradient.addColorStop(1, colors[index][1]);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            currentAngle += sliceAngle;
          });
        };

        const renderBreakdown = (calc) => {
          const { derived } = calc;
          
          if (!breakdownOutputs.canvas) return;
          
          const tax_monthly = derived.tax_monthly;
          const ins_monthly = derived.ins_monthly;
          const hoa_monthly = derived.hoa_monthly;
          const p_and_i = derived.p_and_i;
          const mi = derived.monthly_mi_initial;
          
          const total = p_and_i + tax_monthly + ins_monthly + hoa_monthly + mi;
          
          if (breakdownOutputs.p_and_i) {
            breakdownOutputs.p_and_i.textContent = formatCurrency(p_and_i);
          }
          
          if (breakdownOutputs.tax) {
            breakdownOutputs.tax.textContent = formatCurrency(tax_monthly);
          }
          if (breakdownOutputs.ins) {
            breakdownOutputs.ins.textContent = formatCurrency(ins_monthly);
          }
          if (breakdownOutputs.hoa) {
            breakdownOutputs.hoa.textContent = formatCurrency(hoa_monthly);
          }
          if (breakdownOutputs.mi) {
            breakdownOutputs.mi.textContent = formatCurrency(mi);
          }
          if (breakdownOutputs.mi_row) {
            const miHidden = mi <= 0;
            breakdownOutputs.mi_row.classList.toggle("is-hidden", miHidden);
            const listEl = document.getElementById("breakdown_list");
            if (listEl) {
              const rows = miHidden ? 4 : 5;
              listEl.style.setProperty("--rows", String(rows));
            }
          }
          
          if (breakdownOutputs.chartTotal) {
            breakdownOutputs.chartTotal.innerHTML = `${formatCurrency(total)}<span>/mo</span>`;
          }
          
          fitCanvasToParent(breakdownOutputs.canvas);
          const ctx = breakdownOutputs.canvas.getContext("2d");
          const data = [p_and_i, tax_monthly, ins_monthly, hoa_monthly];
          if (mi > 0) data.push(mi);
          
          const colors = [
            // P&I ‚Äî cyan
            ["rgba(14, 165, 233, 0.95)", "rgba(56, 189, 248, 0.85)"],
            // Tax ‚Äî indigo/violet
            ["rgba(99, 102, 241, 0.95)", "rgba(139, 92, 246, 0.85)"],
            // Insurance ‚Äî fuchsia/purple (distinct from tax)
            ["rgba(168, 85, 247, 0.95)", "rgba(217, 70, 239, 0.85)"],
            // HOA ‚Äî teal/emerald
            ["rgba(20, 184, 166, 0.95)", "rgba(45, 212, 191, 0.85)"],
            // MI (optional) ‚Äî blue
            ["rgba(59, 130, 246, 0.95)", "rgba(96, 165, 250, 0.85)"],
          ];
          
          drawDonutChart(ctx, data, colors);
          // Constrain list to match chart height (fluid, computed per render)
          const listEl = document.getElementById("breakdown_list");
          if (listEl) {
            const chartH = breakdownOutputs.canvas.getBoundingClientRect().height;
            listEl.style.height = `${Math.max(160, Math.round(chartH))}px`;
          }
        };

        const syncBreakdownToMain = () => {
          if (breakdownInputs.tax && inputs.property_tax_input) {
            const monthlyTax = toNumber(breakdownInputs.tax.value);
            const yearlyTax = monthlyTax * 12;
            inputs.property_tax_input.value = yearlyTax.toFixed(2);
          }
          
          if (breakdownInputs.ins && inputs.homeowners_insurance_yearly) {
            const monthlyIns = toNumber(breakdownInputs.ins.value);
            const yearlyIns = monthlyIns * 12;
            inputs.homeowners_insurance_yearly.value = Math.round(yearlyIns);
          }
          
          if (breakdownInputs.hoa && inputs.hoa_monthly) {
            inputs.hoa_monthly.value = Math.round(toNumber(breakdownInputs.hoa.value));
          }
        };

        const calculateAndRender = () => {
          if (!validateInputs()) {
            return;
          }
          const params = readParams();
          const calc = mortgageCalculator.calculate_mortgage(params);
          renderSummary(calc);
          renderBreakdown(calc);
          updateCarousel();
          updateSliderPositions();
        };

        const CAROUSEL_STORAGE_KEY = "mortgage-carousel-index";
        const persistCarouselIndex = () => {
          try {
            sessionStorage.setItem(CAROUSEL_STORAGE_KEY, String(carousel.index));
          } catch (err) {
            console.debug("Unable to persist carousel index", err);
          }
        };

        const loadCarouselIndex = () => {
          try {
            const stored = sessionStorage.getItem(CAROUSEL_STORAGE_KEY);
            if (stored !== null) {
              const parsed = Number(stored);
              if (!Number.isNaN(parsed)) {
                carousel.index = parsed;
              }
            }
          } catch (err) {
            console.debug("Unable to load carousel index", err);
          }
        };

        let lastCarouselIndex = carousel.index;
        let isInitialCarouselSync = true;
        const updateCarousel = () => {
          if (!carousel.track) return;
          const clamped = Math.max(0, Math.min(carousel.index, carousel.slides.length - 1));
          const changed = clamped !== lastCarouselIndex;
          carousel.index = clamped;
          const viewportWidth = carousel.track.parentElement ? carousel.track.parentElement.getBoundingClientRect().width : 0;
          carousel.track.style.transform = `translateX(${-(clamped * viewportWidth)}px)`;

          if (carousel.prev) {
            const disabled = clamped === 0;
            carousel.prev.disabled = disabled;
            carousel.prev.setAttribute("aria-disabled", String(disabled));
          }
          if (carousel.next) {
            const disabled = clamped === carousel.slides.length - 1;
            carousel.next.disabled = disabled;
            carousel.next.setAttribute("aria-disabled", String(disabled));
          }

          // Reflect visible slide for screen readers
          carousel.slides.forEach((slide, idx) => {
            const isCurrent = idx === clamped;
            slide.setAttribute("aria-hidden", String(!isCurrent));
            if (isCurrent) slide.setAttribute("aria-current", "true");
            else slide.removeAttribute("aria-current");
          });

          persistCarouselIndex();

          // Persist widget state in host if available
          try {
            if (window?.openai?.setWidgetState) {
              window.openai.setWidgetState({ carouselIndex: clamped });
            }
          } catch (_) {
            /* ignore */
          }

          if (!isInitialCarouselSync && changed) {
            const cardId = carousel.slides[clamped]?.dataset.card || "unknown";
            emitTelemetry("carousel_navigated", { index: clamped, card: cardId });
          }
          lastCarouselIndex = clamped;
          if (isInitialCarouselSync) {
            isInitialCarouselSync = false;
          }
        };

        const moveCarousel = (delta) => {
          carousel.index += delta;
          updateCarousel();
        };

        if (carousel.prev) {
          carousel.prev.addEventListener("click", () => moveCarousel(-1));
        }

        if (carousel.next) {
          carousel.next.addEventListener("click", () => moveCarousel(1));
        }

        const resetButton = $("resetBtn");
        if (resetButton) {
          resetButton.addEventListener("click", () => {
            setDefaults(baseDefaults);
            mergeProgramDefaults();
            calculateAndRender();
          });
        }

        // Feedback modal & tracking
        const feedbackBtn = $("feedbackBtn");
        if (feedbackBtn) {
          let fbOverlay, fbTextarea, fbStatusEl, fbCancelBtn, fbSubmitBtn;

          const ensureFeedbackModal = () => {
            if (fbOverlay) return;
            fbOverlay = document.createElement('div');
            fbOverlay.className = 'modal-overlay';
            fbOverlay.innerHTML = `
              <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="fbTitle">
                <h3 id="fbTitle">Share feedback</h3>
                <p>Tell us what worked or what could be improved.</p>
                <textarea id="fbText" placeholder="Your feedback..."></textarea>
                <div id="fbStatus" class="modal-status"></div>
                <div class="modal-actions">
                  <button type="button" id="fbCancel">Cancel</button>
                  <button type="button" id="fbSubmit" class="primary">Send</button>
                </div>
              </div>`;
            document.body.appendChild(fbOverlay);
            fbTextarea = fbOverlay.querySelector('#fbText');
            fbStatusEl = fbOverlay.querySelector('#fbStatus');
            fbCancelBtn = fbOverlay.querySelector('#fbCancel');
            fbSubmitBtn = fbOverlay.querySelector('#fbSubmit');

            const onCancel = () => { fbOverlay.style.display = 'none'; };
            fbCancelBtn.addEventListener('click', onCancel);
            fbOverlay.addEventListener('click', (e) => { if (e.target === fbOverlay) onCancel(); });
            fbTextarea.addEventListener('keydown', (e) => {
              if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') submitFeedback();
            });
            fbSubmitBtn.addEventListener('click', () => submitFeedback());
          };

          const openFeedback = () => {
            ensureFeedbackModal();
            if (fbStatusEl) fbStatusEl.textContent = '';
            if (fbTextarea) fbTextarea.value = '';
            fbOverlay.style.display = 'flex';
            setTimeout(() => fbTextarea?.focus(), 0);
          };

          const TRACK_ENDPOINTS = [
            'https://mortgage-calculator-open-ai.onrender.com/api/track',
            'http://localhost:8000/api/track',
            '/api/track',
          ];

          const postJson = async (url, payload) => {
            return fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              mode: 'cors',
              body: JSON.stringify(payload),
            });
          };

          const submitFeedback = async () => {
            const feedback = (fbTextarea?.value || '').trim();
            if (!feedback) {
              if (fbStatusEl) fbStatusEl.textContent = 'Please enter feedback.';
              return;
            }
            if (fbStatusEl) fbStatusEl.textContent = 'Sending‚Ä¶';
            try { emitTelemetry('user_feedback', { feedback }); } catch (_) {}

            try {
              let ok = false;
              for (const url of TRACK_ENDPOINTS) {
                try {
                  const resp = await postJson(url, { event: 'user_feedback', data: { feedback } });
                  if (resp && resp.ok) { ok = true; break; }
                } catch (_) {
                  // try next endpoint
                }
              }
              if (ok) {
                if (fbStatusEl) fbStatusEl.textContent = 'Thanks for your feedback!';
                fbOverlay.style.display = 'none';
                window.setTimeout(() => window.alert('Thanks for your feedback!'), 50);
              } else {
                if (fbStatusEl) fbStatusEl.textContent = 'Failed to send feedback. Please try again.';
                showToast('error', 'Feedback failed');
              }
            } catch (err) {
              console.error('Notify subscription error', err);
              if (fbStatusEl) fbStatusEl.textContent = 'Failed to send feedback. Please try again.';
              showToast('error', 'Feedback failed');
            }
          };

          feedbackBtn.addEventListener('click', (e) => { e.preventDefault(); openFeedback(); });
        }

        const recalcButton = $("calculateBtn");
        if (recalcButton) {
          recalcButton.addEventListener("click", calculateAndRender);
        }

        inputs.loan_type.addEventListener("change", () => {
          mergeProgramDefaults();
          updateVaDisabledVeteranVisibility();
          calculateAndRender();
        });

        // VA disabled veteran checkbox handler
        if (inputs.va_disabled_veteran) {
          inputs.va_disabled_veteran.addEventListener("change", () => {
            calculateAndRender();
          });
        }

        // ZIP code and home value change handlers for auto-estimation
        if (inputs.zip_code) {
          inputs.zip_code.addEventListener("change", () => {
            estimateFromZipAndPrice();
            calculateAndRender();
          });
          inputs.zip_code.addEventListener("blur", () => {
            estimateFromZipAndPrice();
            calculateAndRender();
          });
        }

        if (inputs.home_value) {
          inputs.home_value.addEventListener("change", () => {
            estimateFromZipAndPrice();
          });
        }

        loadCarouselIndex();
        updateMiVisibility();
        updateVaDisabledVeteranVisibility();
        updateCarousel();
        let resizeRaf = 0;
        window.addEventListener("resize", () => {
          if (resizeRaf) cancelAnimationFrame(resizeRaf);
          resizeRaf = requestAnimationFrame(() => {
            updateCarousel();
            const breakdownSlide = document.querySelector('.carousel-slide[data-card="breakdown"]');
            const isBreakdownVisible = breakdownSlide && breakdownSlide.getAttribute('aria-hidden') === 'false';
            if (isBreakdownVisible) {
              if (breakdownOutputs.canvas) fitCanvasToParent(breakdownOutputs.canvas);
              const params = readParams();
              const calc = mortgageCalculator.calculate_mortgage(params);
              renderBreakdown(calc);
            }
          });
        });

        const carouselWindowEl = document.querySelector(".carousel-window");
        let pointerStartX = null;
        const SWIPE_THRESHOLD = 30;

        if (carouselWindowEl) {
          carouselWindowEl.addEventListener("pointerdown", (event) => {
            if (event.pointerType === "touch" || event.pointerType === "pen") {
              pointerStartX = event.clientX;
            }
          });

          const handlePointerEnd = (event) => {
            if (pointerStartX === null) return;
            const deltaX = event.clientX - pointerStartX;
            if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
              moveCarousel(deltaX < 0 ? 1 : -1);
            }
            pointerStartX = null;
          };

          carouselWindowEl.addEventListener("pointerup", handlePointerEnd);
          carouselWindowEl.addEventListener("pointercancel", () => {
            pointerStartX = null;
          });
        }

        document.addEventListener("keydown", (event) => {
          const target = event.target;
          if (target && ["INPUT", "SELECT", "TEXTAREA"].includes(target.tagName)) {
            return;
          }

          if (event.key === "ArrowLeft") {
            event.preventDefault();
            moveCarousel(-1);
          } else if (event.key === "ArrowRight") {
            event.preventDefault();
            moveCarousel(1);
          }
        });

        const scenarioConfigs = {
          "first-time": (current) => {
            const hv = Math.max(100000, toNumber(current.home_value.value) || baseDefaults.home_value);
            return {
              loan_type: "conventional",
              down_payment_value: Math.round(hv * 0.03),
              rate_apr: Math.max(4.5, toNumber(current.rate_apr.value) || baseDefaults.rate_apr),
              term_years: 30,
            };
          },
          conventional: (current) => {
            const hv = Math.max(100000, toNumber(current.home_value.value) || baseDefaults.home_value);
            return {
              loan_type: "conventional",
              down_payment_value: Math.round(hv * 0.2),
              rate_apr: toNumber(current.rate_apr.value) || baseDefaults.rate_apr,
              term_years: 30,
            };
          },
          va: () => ({
            loan_type: "VA",
            down_payment_value: 0,
            term_years: 30,
          }),
        };

        const applyScenario = (scenarioKey) => {
          const configFn = scenarioConfigs[scenarioKey];
          if (!configFn) return;
          const overrides = configFn(inputs);
          Object.entries(overrides).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          if (overrides.loan_type) {
            mergeProgramDefaults();
            updateVaDisabledVeteranVisibility();
          }
          updateSliderPositions();
          calculateAndRender();
        };

        const markActiveScenario = (target) => {
          if (!scenarioBar) return;
          scenarioBar.querySelectorAll(".scenario-chip").forEach((chip) => {
            chip.classList.toggle("active", chip === target);
          });
        };

        if (scenarioBar) {
          scenarioBar.addEventListener("click", (event) => {
            const chip = event.target.closest(".scenario-chip");
            if (!chip) return;
            const key = chip.getAttribute("data-scenario");
            if (!key) return;
            markActiveScenario(chip);
            applyScenario(key);
            emitTelemetry("scenario_applied", { scenario: key });
          });
        }

        const attachSlider = (slider, onChange) => {
          if (!slider) return;
          slider.addEventListener("input", onChange);
          slider.addEventListener("change", onChange);
        };

        attachSlider(sliders.down_payment, () => {
          const hv = toNumber(inputs.home_value.value);
          const pct = Number(sliders.down_payment.value) / 100;
          inputs.down_payment_value.value = Math.round(hv * pct);
          if (sliderDisplays.down_payment) sliderDisplays.down_payment.textContent = `${sliders.down_payment.value}%`;
          calculateAndRender();
        });

        attachSlider(sliders.rate, () => {
          const val = Number(sliders.rate.value);
          inputs.rate_apr.value = val.toFixed(2);
          if (sliderDisplays.rate) sliderDisplays.rate.textContent = `${inputs.rate_apr.value}%`;
          calculateAndRender();
        });

        attachSlider(sliders.term, () => {
          const val = Math.round(Number(sliders.term.value));
          inputs.term_years.value = val;
          if (sliderDisplays.term) sliderDisplays.term.textContent = `${val}y`;
          calculateAndRender();
        });

        

        Object.values(inputs).forEach((el) => {
          const handler = () => {
            if (percentInputSet.has(el.id)) {
              normalizePercentInput(el);
            }
            calculateAndRender();
          };
          el.addEventListener("change", handler);
          if (el.tagName === "INPUT" && el.type === "number") {
            el.addEventListener("keyup", (evt) => {
              if (evt.key === "Enter") handler();
            });
          }
        });

        // Breakdown list is read-only; no input listeners needed.

        // Notify Me When Rates Drop
        const notifyBtn = document.getElementById("notifyRatesBtn");

        const SUBSCRIBE_KEY = "mc_rates_subscribed";
        const markSubscribed = () => {
          try { localStorage.setItem(SUBSCRIBE_KEY, "1"); } catch (_) {}
          try {
            if (window?.openai?.setWidgetState) {
              const s = window.openai.widgetState || {};
              window.openai.setWidgetState({ ...s, hasSubscribedRates: true });
            }
          } catch (_) {}
          if (notifyBtn) notifyBtn.style.display = "none";
          // Hide subscribe banner when user subscribes
          const banner = document.getElementById('subscribeBanner');
          if (banner) banner.classList.add('is-hidden');
        };
        const isSubscribed = (() => {
          try {
            if (window?.openai?.widgetState?.hasSubscribedRates) return true;
            const v = localStorage.getItem(SUBSCRIBE_KEY);
            return v === "1" || v === "true";
          } catch (_) { return false; }
        })();
        if (notifyBtn && isSubscribed) { notifyBtn.style.display = "none"; }

        const centerNotifyUnderRate = () => {
          const header = document.querySelector('.carousel-slide[data-card="summary"] .slide-header');
          const badge = header ? header.querySelector('.rate-badge') : null;
          if (!header || !badge || !notifyBtn || notifyBtn.style.display === 'none') return;
          const headerRect = header.getBoundingClientRect();
          const badgeRect = badge.getBoundingClientRect();
          const btnRect = notifyBtn.getBoundingClientRect();
          const left = badgeRect.left + badgeRect.width / 2 - btnRect.width / 2 - headerRect.left;
          notifyBtn.style.left = `${Math.round(left)}px`;
          notifyBtn.style.right = 'auto';
        };

        if (notifyBtn) {
          let overlay, emailInput, statusEl, cancelBtn, submitBtn;

          const ensureNotifyModal = () => {
            if (overlay) return;
            overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
              <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="notifyTitle">
                <h3 id="notifyTitle">Notify me when rates drop</h3>
                <p>We'll email you when average rates drop.</p>
                <input id="notifyEmail" type="email" placeholder="you@example.com" autocomplete="email" />
                <div id="notifyStatus" class="modal-status"></div>
                <div class="modal-actions">
                  <button type="button" id="notifyCancel">Cancel</button>
                  <button type="button" id="notifySubmit" class="primary">Notify me</button>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            emailInput = overlay.querySelector('#notifyEmail');
            statusEl = overlay.querySelector('#notifyStatus');
            cancelBtn = overlay.querySelector('#notifyCancel');
            submitBtn = overlay.querySelector('#notifySubmit');

            const onCancel = () => { overlay.style.display = 'none'; };
            cancelBtn.addEventListener('click', onCancel);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) onCancel(); });
            emailInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') submit(); });
            submitBtn.addEventListener('click', () => submit());
          };

          const openModal = () => {
            ensureNotifyModal();
            statusEl.textContent = '';
            overlay.style.display = 'flex';
            setTimeout(() => emailInput?.focus(), 0);
          };

          const SUBSCRIBE_ENDPOINTS = [
            'https://mortgage-calculator-open-ai.onrender.com/api/subscribe',
            'http://localhost:8000/api/subscribe',
            '/api/subscribe',
          ];

          const postJson = async (url, payload) => {
            return fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              mode: 'cors',
              body: JSON.stringify(payload),
            });
          };

          const submit = async () => {
            const email = (emailInput?.value || '').trim();
            if (!email || !email.includes('@')) {
              statusEl.textContent = 'Please enter a valid email address.';
              return;
            }
            statusEl.textContent = 'Subscribing‚Ä¶';

            try {
              emitTelemetry("notify_me_subscribe", { type: "rates", email });
              let resp = null;
              let raw = '';
              let data = {};
              const payload = {
                email,
                settlementId: 'mortgage_calculator',
                settlementName: 'Mortgage Calculator',
                deadline: null,
              };
              for (const url of SUBSCRIBE_ENDPOINTS) {
                try {
                  resp = await postJson(url, payload);
                  raw = await resp.text();
                  try { data = raw ? JSON.parse(raw) : {}; } catch (_) { data = {}; }
                  if (resp.ok && (data?.success || data?.id)) break;
                } catch (_) {
                  // Network/CORS failure; clear resp so we don't report stale response
                  resp = null;
                  raw = '';
                  data = {};
                  // try next endpoint
                }
              }
              if (!resp) {
                statusEl.textContent = 'Subscription failed: no response from any endpoint';
                return;
              }
              // raw/data already populated with the last attempt
              if (resp.ok && (data?.success || data?.id)) {
                const code = Math.random().toString(36).slice(2, 8).toUpperCase();
                statusEl.textContent = data.message || "You're subscribed!";
                markSubscribed();
                overlay.style.display = 'none';
                window.setTimeout(() => window.alert(`${data.message || "You're subscribed!"}\nConfirmation: ${code}`), 50);
              } else {
                const detail = data?.error || (typeof data?.detail === 'string' ? data.detail : '') || resp.statusText || raw || 'Unknown error';
                statusEl.textContent = `Subscription failed: ${detail}`;
              }
            } catch (err) {
              console.error('Notify subscription error', err);
              statusEl.textContent = 'Subscription failed. Please try again.';
            }
          };

          notifyBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(); });

          requestAnimationFrame(centerNotifyUnderRate);
          window.addEventListener('resize', centerNotifyUnderRate);
        }

        // Subscribe modal - initialize for subscribe buttons (independent of notify button)
        const subscribeBannerBtnRef = document.getElementById('subscribeBannerBtn');
        const subscribeBtnBottomRef = document.getElementById('subscribeBtnBottom');

        if (subscribeBannerBtnRef || subscribeBtnBottomRef) {
          let subscribeOverlay, subscribeEmailInput, subscribeStatusEl, subscribeCancelBtn, subscribeSubmitBtn;

          const ensureSubscribeModal = () => {
            if (subscribeOverlay) return;
            subscribeOverlay = document.createElement('div');
            subscribeOverlay.className = 'modal-overlay';
            subscribeOverlay.innerHTML = `
              <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="subscribeTitle">
                <h3 id="subscribeTitle">Subscribe for Updates</h3>
                <p>Get expert tips to make smarter mortgage decisions.</p>
                <input id="subscribeEmail" type="email" placeholder="you@example.com" autocomplete="email" />
                <div id="subscribeStatus" class="modal-status"></div>
                <div class="modal-actions">
                  <button type="button" id="subscribeCancel">Cancel</button>
                  <button type="button" id="subscribeSubmit" class="primary">Subscribe</button>
                </div>
              </div>`;
            document.body.appendChild(subscribeOverlay);
            subscribeEmailInput = subscribeOverlay.querySelector('#subscribeEmail');
            subscribeStatusEl = subscribeOverlay.querySelector('#subscribeStatus');
            subscribeCancelBtn = subscribeOverlay.querySelector('#subscribeCancel');
            subscribeSubmitBtn = subscribeOverlay.querySelector('#subscribeSubmit');

            const onSubscribeCancel = () => { subscribeOverlay.style.display = 'none'; };
            subscribeCancelBtn.addEventListener('click', onSubscribeCancel);
            subscribeOverlay.addEventListener('click', (e) => { if (e.target === subscribeOverlay) onSubscribeCancel(); });
            subscribeEmailInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') submitSubscription(); });
            subscribeSubmitBtn.addEventListener('click', () => submitSubscription());
          };

          const openSubscribeModal = () => {
            ensureSubscribeModal();
            subscribeStatusEl.textContent = '';
            subscribeOverlay.style.display = 'flex';
            setTimeout(() => subscribeEmailInput?.focus(), 0);
          };

          const SUBSCRIBE_ENDPOINTS = [
            'https://mortgage-calculator-open-ai.onrender.com/api/subscribe',
            'http://localhost:8000/api/subscribe',
            '/api/subscribe',
          ];

          const postJson = async (url, payload) => {
            return fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              mode: 'cors',
              body: JSON.stringify(payload),
            });
          };

          const submitSubscription = async () => {
            const email = (subscribeEmailInput?.value || '').trim();
            console.log('[Subscribe] Starting subscription for:', email);
            if (!email || !email.includes('@')) {
              subscribeStatusEl.textContent = 'Please enter a valid email address.';
              return;
            }
            subscribeStatusEl.textContent = 'Subscribing‚Ä¶';

            try {
              emitTelemetry("notify_me_subscribe", { type: "rates", email });
              let resp = null;
              let raw = '';
              let data = {};
              const payload = {
                email,
                settlementId: 'mortgage_calculator',
                settlementName: 'Mortgage Calculator',
                deadline: null,
              };
              console.log('[Subscribe] Payload:', payload);
              console.log('[Subscribe] Trying endpoints:', SUBSCRIBE_ENDPOINTS);
              
              for (const url of SUBSCRIBE_ENDPOINTS) {
                console.log('[Subscribe] Trying endpoint:', url);
                try {
                  resp = await postJson(url, payload);
                  console.log('[Subscribe] Response status:', resp.status, resp.statusText);
                  raw = await resp.text();
                  console.log('[Subscribe] Raw response:', raw);
                  try { data = raw ? JSON.parse(raw) : {}; } catch (_) { data = {}; }
                  console.log('[Subscribe] Parsed data:', data);
                  if (resp.ok && (data?.success || data?.id)) {
                    console.log('[Subscribe] Success! Breaking loop.');
                    break;
                  }
                  console.log('[Subscribe] Endpoint failed, trying next...');
                } catch (endpointErr) {
                  console.error('[Subscribe] Endpoint error:', url, endpointErr);
                  resp = null;
                  raw = '';
                  data = {};
                }
              }
              console.log('[Subscribe] Loop complete. resp:', resp, 'data:', data);
              if (!resp) {
                console.error('[Subscribe] No response from any endpoint');
                subscribeStatusEl.textContent = 'Subscription failed: no response from any endpoint';
                return;
              }
              if (resp.ok && (data?.success || data?.id)) {
                const code = Math.random().toString(36).slice(2, 8).toUpperCase();
                subscribeStatusEl.textContent = data.message || "You're subscribed!";
                markSubscribed();
                subscribeOverlay.style.display = 'none';
                window.setTimeout(() => window.alert(`${data.message || "You're subscribed!"}\nConfirmation: ${code}`), 50);
              } else {
                const detail = data?.error || (typeof data?.detail === 'string' ? data.detail : '') || resp.statusText || raw || 'Unknown error';
                console.error('[Subscribe] Failed with detail:', detail);
                subscribeStatusEl.textContent = `Subscription failed: ${detail}`;
              }
            } catch (err) {
              console.error('[Subscribe] Outer error:', err);
              subscribeStatusEl.textContent = 'Subscription failed. Please try again.';
            }
          };

          // Subscribe banner button opens modal
          if (subscribeBannerBtnRef) {
            subscribeBannerBtnRef.addEventListener('click', (e) => { e.preventDefault(); openSubscribeModal(); });
          }

          // Subscribe button at bottom opens modal
          if (subscribeBtnBottomRef) {
            subscribeBtnBottomRef.addEventListener('click', (e) => { e.preventDefault(); openSubscribeModal(); });
          }
        }

        // Subscribe banner close functionality
        const subscribeBanner = document.getElementById('subscribeBanner');
        const subscribeBannerClose = document.getElementById('subscribeBannerClose');
        const BANNER_DISMISSED_KEY = 'mc_subscribe_banner_dismissed';

        // Check if banner was previously dismissed
        try {
          if (localStorage.getItem(BANNER_DISMISSED_KEY) === '1' && subscribeBanner) {
            subscribeBanner.classList.add('is-hidden');
          }
        } catch (_) {}

        // Also hide banner if already subscribed
        if (subscribeBanner && isSubscribed) {
          subscribeBanner.classList.add('is-hidden');
        }

        if (subscribeBannerClose) {
          subscribeBannerClose.addEventListener('click', () => {
            if (subscribeBanner) subscribeBanner.classList.add('is-hidden');
            try { localStorage.setItem(BANNER_DISMISSED_KEY, '1'); } catch (_) {}
          });
        }

        // Load daily rate (FRED + 0.5%) and robustly update badge with retries and guard
        const RATE_ENDPOINTS = [
          '/api/rate',
          'https://mortgage-calculator-open-ai.onrender.com/api/rate',
          'http://localhost:8000/api/rate',
        ];

        const applyRateBadge = (val) => {
          const numEl = document.querySelector('.rate-badge .rate-num');
          if (!numEl) return false;
          const text = `${val}%`;
          if (numEl.textContent !== text) numEl.textContent = text;
          try { numEl.setAttribute('data-rate', String(val)); } catch (_) {}
          requestAnimationFrame(() => {
            if (typeof centerNotifyUnderRate === 'function') centerNotifyUnderRate();
          });
          return true;
        };

        const fetchRateOnce = async () => {
          for (const url of RATE_ENDPOINTS) {
            try {
              const resp = await fetch(url, { cache: 'no-store' });
              if (!resp.ok) continue;
              const data = await resp.json();
              const val = Number(data?.ratePercent);
              if (Number.isFinite(val)) return val;
            } catch (_) {
              // try next endpoint
            }
          }
          return null;
        };

        const guardRateBadge = (expectedText, ms = 10000) => {
          const numEl = document.querySelector('.rate-badge .rate-num');
          if (!numEl || typeof MutationObserver === 'undefined') return;
          const end = Date.now() + ms;
          const obs = new MutationObserver(() => {
            if (Date.now() > end) { obs.disconnect(); return; }
            if (numEl.textContent !== expectedText) {
              numEl.textContent = expectedText;
            }
          });
          obs.observe(numEl, { childList: true, characterData: true, subtree: true });
          // Stop guarding after ms
          setTimeout(() => obs.disconnect(), ms + 50);
        };

        const refreshRateBadge = async (maxTries = 6) => {
          try { emitTelemetry("rate_fetch_attempt", { maxTries }); } catch (_) {}
          for (let attempt = 0; attempt < maxTries; attempt++) {
            const val = await fetchRateOnce();
            if (val != null) {
              try { emitTelemetry("rate_fetch_success", { attempt, value: val }); } catch (_) {}
              const applied = applyRateBadge(val);
              if (applied) guardRateBadge(`${val}%`, 12000);
              return;
            }
            try { emitTelemetry("rate_fetch_retry", { attempt }); } catch (_) {}
            const delay = Math.min(8000, 500 * Math.pow(2, attempt));
            await new Promise((r) => setTimeout(r, delay));
          }
          try { emitTelemetry("rate_fetch_failed", {}); } catch (_) {}
        };

        // Read parameters from ChatGPT tool call if available (robust fallbacks)
        const DEBUG_HYDRATION = true;
        const pickProvided = (src) => {
          if (!src || typeof src !== 'object') return {};
          const out = {};
          const parseNumberish = (v) => {
            if (typeof v === 'number') return v;
            if (typeof v === 'string') {
              const cleaned = v.replace(/[$,\s]/g, '');
              const n = Number(cleaned);
              if (Number.isFinite(n)) return n;
            }
            return v;
          };
          const setIf = (k, v) => {
            if (v !== undefined && v !== null) {
              const keysNeedingNum = new Set(['home_value','down_payment_value','rate_apr','term_years','property_tax_input','homeowners_insurance_yearly','hoa_monthly','pmi_pct','annual_mi_pct','upfront_fee_pct','start_month','start_year','extra_principal_monthly','extra_start_month_index']);
              out[k] = keysNeedingNum.has(k) ? parseNumberish(v) : v;
            }
          };
          setIf('loan_type', src.loan_type);
          setIf('home_value', src.home_value);
          setIf('down_payment_value', src.down_payment_value);
          setIf('rate_apr', src.rate_apr);
          setIf('term_years', src.term_years);
          setIf('zip_code', src.zip_code);
          setIf('credit_score', src.credit_score);
          setIf('property_tax_input', src.property_tax_input);
          setIf('homeowners_insurance_yearly', src.homeowners_insurance_yearly);
          setIf('hoa_monthly', src.hoa_monthly);
          setIf('pmi_pct', src.pmi_pct);
          setIf('annual_mi_pct', src.annual_mi_pct);
          setIf('upfront_fee_pct', src.upfront_fee_pct);
          setIf('finance_upfront_fee', src.finance_upfront_fee);
          setIf('start_month', src.start_month);
          setIf('start_year', src.start_year);
          setIf('extra_principal_monthly', src.extra_principal_monthly);
          setIf('extra_start_month_index', src.extra_start_month_index);
          return out;
        };
        const readProvidedParams = () => {
          const oa = (window && window.openai) ? window.openai : {};
          const candidates = [
            oa.toolOutput,
            oa.structuredContent,
            oa.result?.structuredContent,
            oa.toolInput,
          ];
          for (const c of candidates) {
            const p = pickProvided(c);
            if (Object.keys(p).length) {
              if (DEBUG_HYDRATION) console.debug('[Hydration] Found provided params source:', c === oa.toolOutput ? 'toolOutput' : (c === oa.structuredContent ? 'structuredContent' : (c === oa.toolInput ? 'toolInput' : 'result.structuredContent')), p);
              return p;
            }
          }
          if (DEBUG_HYDRATION) console.debug('[Hydration] No provided params found. openai keys:', Object.keys(oa || {}));
          return {};
        };
        const providedParams = readProvidedParams();
        
        // Merge provided parameters with base defaults
        setDefaults(baseDefaults);
        if (providedParams && typeof providedParams === 'object' && 'loan_type' in providedParams && providedParams.loan_type) {
          if (inputs.loan_type) inputs.loan_type.value = providedParams.loan_type;
        }
        mergeProgramDefaults();
        if (providedParams && Object.keys(providedParams).length > 0) {
          setDefaults(providedParams);
        }
        calculateAndRender();

        // Late overlay retry in case window.openai is attached slightly after execution
        let retries = 0;
        const tryLateOverlay = () => {
          if (didUserEdit) return;
          const late = readProvidedParams();
          if (late && Object.keys(late).length > 0) {
            if (DEBUG_HYDRATION) console.debug('[Hydration] Late overlay with provided params', late);
            if (late.loan_type) { try { inputs.loan_type.value = late.loan_type; mergeProgramDefaults(); } catch(_){} }
            setDefaults(late);
            calculateAndRender();
            return true;
          }
          return false;
        };
        setTimeout(() => { if (!tryLateOverlay()) {
          const id = setInterval(() => {
            retries += 1;
            if (tryLateOverlay() || retries >= 6) clearInterval(id);
          }, 200);
        } }, 50);

        window.addEventListener('openai:set_globals', (ev) => {
          if (didUserEdit) return;
          const globals = ev?.detail?.globals || {};
          const props = pickProvided(globals.toolOutput || globals.structuredContent || globals.toolInput || {});
          if (props && Object.keys(props).length > 0) {
            if (DEBUG_HYDRATION) console.debug('[Hydration] Event overlay from set_globals', props);
            if (props.loan_type) { try { inputs.loan_type.value = props.loan_type; mergeProgramDefaults(); } catch(_){} }
            setDefaults(props);
            calculateAndRender();
          }
        }, { passive: true });

        // Fetch and display the latest daily rate from server (FRED + 0.5%)
        let rateBadgeRefreshing = false;

        const refreshRateBadgeWithState = async () => {
          if (rateBadgeRefreshing) return;
          rateBadgeRefreshing = true;
          try {
            await refreshRateBadge();
          } finally {
            rateBadgeRefreshing = false;
          }
        };

        refreshRateBadgeWithState();

        const rateRefreshBtn = document.querySelector('.rate-refresh');
        if (rateRefreshBtn) {
          rateRefreshBtn.addEventListener('click', async () => {
            if (rateBadgeRefreshing) return;
            rateRefreshBtn.classList.add('is-spinning');
            try {
              await refreshRateBadgeWithState();
            } finally {
              rateRefreshBtn.classList.remove('is-spinning');
            }
          });
        }

        // ===== SAVED CALCULATIONS FEATURE =====
        const SAVED_CALCS_KEY = 'mc_saved_calculations';
        const savedCalcsSection = document.getElementById('savedCalculationsSection');
        const savedCalcsList = document.getElementById('savedCalculationsList');

        // Load saved calculations from localStorage
        const loadSavedCalculations = () => {
          try {
            const stored = localStorage.getItem(SAVED_CALCS_KEY);
            return stored ? JSON.parse(stored) : [];
          } catch (_) { return []; }
        };

        // Save calculations to localStorage
        const persistSavedCalculations = (calcs) => {
          try {
            localStorage.setItem(SAVED_CALCS_KEY, JSON.stringify(calcs));
          } catch (_) {}
        };

        // Format currency for display in saved items
        const formatSavedCurrency = (val) => {
          return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
        };

        // Render saved calculations list
        const savedCalcsBadge = document.getElementById('savedCalcsBadge');
        const renderSavedCalculations = () => {
          const calcs = loadSavedCalculations();
          
          // Update badge count
          if (savedCalcsBadge) {
            savedCalcsBadge.textContent = calcs.length;
            savedCalcsBadge.setAttribute('data-count', calcs.length);
          }
          
          // Show/hide panel based on count
          if (calcs.length === 0) {
            savedCalcsSection.style.display = 'none';
            return;
          }
          savedCalcsSection.style.display = '';
          
          savedCalcsList.innerHTML = calcs.map((calc, idx) => `
            <div class="saved-calc-item" data-index="${idx}">
              <div class="saved-calc-info">
                <div class="saved-calc-name">${escapeHtml(calc.name)}</div>
                <div class="saved-calc-meta">${formatSavedCurrency(calc.data.home_value)} ‚Ä¢ ${calc.data.loan_type} ‚Ä¢ ${calc.data.term_years}yr</div>
              </div>
              <div class="saved-calc-actions">
                <button type="button" class="saved-calc-btn load-btn" data-action="load" data-index="${idx}" title="Load this calculation">
                  Load
                </button>
                <button type="button" class="saved-calc-btn" data-action="rename" data-index="${idx}" title="Rename">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                  </svg>
                </button>
                <button type="button" class="saved-calc-btn" data-action="duplicate" data-index="${idx}" title="Duplicate">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                  </svg>
                </button>
                <button type="button" class="saved-calc-btn delete-btn" data-action="delete" data-index="${idx}" title="Delete">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"/>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>
          `).join('');
        };

        // Escape HTML to prevent XSS
        const escapeHtml = (str) => {
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        };

        // Get current calculation data
        const getCurrentCalcData = () => {
          const data = {};
          Object.entries(inputs).forEach(([key, el]) => {
            if (!el) return;
            if (el.type === 'checkbox') {
              data[key] = el.checked;
            } else {
              data[key] = el.value;
            }
          });
          return data;
        };

        // Apply saved calculation data to inputs
        const applyCalcData = (data) => {
          Object.entries(data).forEach(([key, value]) => {
            if (!(key in inputs) || !inputs[key]) return;
            const el = inputs[key];
            if (el.type === 'checkbox') {
              el.checked = Boolean(value);
            } else {
              el.value = value;
            }
          });
          updateSliderPositions();
          updateMiVisibility();
          updateVaDisabledVeteranVisibility();
          calculateAndRender();
        };

        // Modal for save/rename
        let saveModalOverlay = null;
        let saveModalInput = null;
        let saveModalCallback = null;

        const ensureSaveModal = () => {
          if (saveModalOverlay) return;
          saveModalOverlay = document.createElement('div');
          saveModalOverlay.className = 'save-modal-overlay';
          saveModalOverlay.innerHTML = `
            <div class="save-modal">
              <h3 id="saveModalTitle">Save Calculation</h3>
              <input type="text" id="saveModalInput" placeholder="Enter a name..." maxlength="50" />
              <div class="save-modal-actions">
                <button type="button" class="save-modal-btn cancel" id="saveModalCancel">Cancel</button>
                <button type="button" class="save-modal-btn primary" id="saveModalConfirm">Save</button>
              </div>
            </div>
          `;
          document.body.appendChild(saveModalOverlay);
          saveModalInput = saveModalOverlay.querySelector('#saveModalInput');
          
          const closeModal = () => {
            saveModalOverlay.classList.remove('is-open');
            saveModalCallback = null;
          };
          
          saveModalOverlay.querySelector('#saveModalCancel').addEventListener('click', closeModal);
          saveModalOverlay.addEventListener('click', (e) => {
            if (e.target === saveModalOverlay) closeModal();
          });
          
          saveModalOverlay.querySelector('#saveModalConfirm').addEventListener('click', () => {
            const name = saveModalInput.value.trim();
            if (name && saveModalCallback) {
              saveModalCallback(name);
            }
            closeModal();
          });
          
          saveModalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              const name = saveModalInput.value.trim();
              if (name && saveModalCallback) {
                saveModalCallback(name);
              }
              closeModal();
            } else if (e.key === 'Escape') {
              closeModal();
            }
          });
        };

        const openSaveModal = (title, defaultName, callback) => {
          ensureSaveModal();
          saveModalOverlay.querySelector('#saveModalTitle').textContent = title;
          saveModalInput.value = defaultName;
          saveModalCallback = callback;
          saveModalOverlay.classList.add('is-open');
          setTimeout(() => {
            saveModalInput.focus();
            saveModalInput.select();
          }, 50);
        };

        // Save button click handler (highlight button in summary card)
        const highlightSaveBtn = document.getElementById('highlightSaveBtn');
        const triggerSaveModal = () => {
          const homeValue = toNumber(inputs.home_value?.value) || 0;
          const loanType = inputs.loan_type?.value || 'Conventional';
          const defaultName = `${loanType} - ${formatSavedCurrency(homeValue)}`;
          
          openSaveModal('Save Calculation', defaultName, (name) => {
            const calcs = loadSavedCalculations();
            calcs.unshift({
              id: Date.now(),
              name: name,
              data: getCurrentCalcData(),
              savedAt: new Date().toISOString()
            });
            persistSavedCalculations(calcs);
            renderSavedCalculations();
            emitTelemetry('calculation_saved', { name });
          });
        };

        if (highlightSaveBtn) {
          highlightSaveBtn.addEventListener('click', triggerSaveModal);
        }

        // Print button click handler (highlight button in summary card)
        const highlightPrintBtn = document.getElementById('highlightPrintBtn');
        if (highlightPrintBtn) {
          highlightPrintBtn.addEventListener('click', () => {
            try { emitTelemetry("print_clicked", {}); } catch (_) {}
            try { window.print?.(); } catch (_) {}
          });
        }

        // Handle saved calc actions (load, rename, duplicate, delete)
        if (savedCalcsList) {
          savedCalcsList.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            
            const action = btn.dataset.action;
            const index = parseInt(btn.dataset.index, 10);
            const calcs = loadSavedCalculations();
            
            if (index < 0 || index >= calcs.length) return;
            
            switch (action) {
              case 'load':
                applyCalcData(calcs[index].data);
                emitTelemetry('calculation_loaded', { name: calcs[index].name });
                break;
                
              case 'rename':
                openSaveModal('Rename Calculation', calcs[index].name, (newName) => {
                  calcs[index].name = newName;
                  persistSavedCalculations(calcs);
                  renderSavedCalculations();
                  emitTelemetry('calculation_renamed', { name: newName });
                });
                break;
                
              case 'duplicate':
                const dup = { ...calcs[index], id: Date.now(), name: calcs[index].name + ' (copy)' };
                calcs.splice(index + 1, 0, dup);
                persistSavedCalculations(calcs);
                renderSavedCalculations();
                emitTelemetry('calculation_duplicated', { name: dup.name });
                break;
                
              case 'delete':
                const name = calcs[index].name;
                calcs.splice(index, 1);
                persistSavedCalculations(calcs);
                renderSavedCalculations();
                emitTelemetry('calculation_deleted', { name });
                break;
            }
          });
        }

        // Initialize saved calculations on load
        renderSavedCalculations();

        // Component loaded telemetry (Apps SDK guidance)
        emitTelemetry("component_loaded", { slides: carousel.slides.length });
      })();
    </script>
  </body>
</html>
